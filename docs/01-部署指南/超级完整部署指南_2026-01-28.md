# DashGo Sim2Real 超级完整部署指南

> **创建时间**: 2026-01-28 20:20:00
> **版本**: 超级完整版 v1.0
> **针对环境**: Ubuntu 20.04 + Isaac Sim 4.5 + ROS Noetic
> **作者**: Isaac Sim Architect + Claude Code
> **项目路径**: `/home/gwh/dashgo_rl_project`
> **特性**: 最新 + 精准 + 全面

---

## 🎯 指南概述

本指南融合了所有部署文档的优点，提供：
- ✅ **最新**: 包含v3.2-Safe所有安全增强修改
- ✅ **精准**: 针对你的环境优化（env_isaaclab、项目路径）
- ✅ **全面**: 从模型导出到成功运行的完整流程

### 部署流程图

```
阶段0: 前置检查 → 阶段1: 模型导出 → 阶段2: 编译ROS → 阶段3: 启动仿真 → 阶段4: 发送目标 → 阶段5: 验证
```

**预计时间**: 15-25分钟（根据环境状态）

---

## 🚀 快速判断：你应该从哪个阶段开始？

### 情况A：第一次部署（模型已训练，但未导出）
→ **从阶段0开始**，完整执行所有阶段

### 情况B：模型已导出，ROS已编译，想直接测试
→ **跳到阶段3**（启动仿真），使用3终端策略

### 情况C：之前测试失败，想重新开始
→ **从阶段1开始**，重新导出和编译

---

## 🎯 阶段0：前置检查（2分钟）

### 目的
确认你的环境满足所有要求，避免后续步骤报错。

### 检查清单

```bash
# 打开终端，执行以下检查
```

#### 检查1：项目目录

```bash
# 确认项目目录存在
ls -d ~/dashgo_rl_project
# 应该输出: /home/gwh/dashgo_rl_project
```

#### 检查2：ROS Noetic

```bash
# 检查ROS版本
rosversion -d
# 应该输出: Noetic
```

#### 检查3：训练模型

```bash
# 检查是否有训练好的模型
ls -lh ~/dashgo_rl_project/logs/model_*.pt | tail -3
```

**预期输出**:
```
-rw-r--r-- 1 gwh gwh 5.2M 1月  27 16:11 model_900.pt
-rw-r--r-- 1 gwh gwh 5.2M 1月  27 15:37 model_0.pt
```

#### 检查4：Conda环境

```bash
# 检查env_isaaclab环境是否存在
conda env list | grep env_isaaclab
# 应该看到: env_isaaclab
```

#### 检查5：TorchScript模型（如果已导出）

```bash
# 检查TorchScript模型是否存在
ls -lh ~/dashgo_rl_project/catkin_ws/src/dashgo_rl/models/policy_torchscript.pt
```

**如果看到1.8MB的文件** → ✅ 可以跳过阶段1，直接到阶段2或3

---

## 🚀 阶段1：模型导出（3分钟）

> **跳过条件**: 如果 `policy_torchscript.pt` 已存在（1.8MB），可以直接跳到阶段2

### 目标
将PyTorch训练模型转换为TorchScript格式，用于ROS部署。

### 步骤1.1：打开新终端并激活环境

```bash
# 打开新终端（Ctrl + Alt + T）

# 激活conda环境
conda activate env_isaaclab

# 进入项目目录
cd ~/dashgo_rl_project
```

**预期输出**:
```
(env_isaaclab) gwh@ubuntu:~/dashgo_rl_project$
```

### 步骤1.2：导出TorchScript模型

```bash
# 方法1：自动查找并导出最新模型（推荐）
python export_torchscript.py

# 方法2：导出指定模型
python export_torchscript.py --checkpoint logs/model_900.pt
```

**预期输出**:
```
✅ 模型导出成功！
保存路径: catkin_ws/src/dashgo_rl/models/policy_torchscript.pt
模型大小: 1.8 MB
```

### 步骤1.3：验证导出结果

```bash
# 检查文件是否存在
ls -lh catkin_ws/src/dashgo_rl/models/policy_torchscript.pt

# 应该显示：
# -rw-r--r-- 1 gwh gwh 1.8M ... policy_torchscript.pt
```

### 🔧 故障排查

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `ModuleNotFoundError: No module named 'isaaclab'` | 未激活Isaac Sim环境 | 检查conda环境是否激活 |
| `RuntimeError: model forward() method not found` | 模型版本过低 | 检查geo_nav_policy.py是否为v3.2 |
| `FileNotFoundError: model_*.pt` | 模型文件不存在 | 检查logs目录是否有.pt文件 |

---

## 🔨 阶段2：编译ROS工作空间（3分钟）

> **跳过条件**: 如果之前已编译成功，且没有修改代码，可以跳过

### 目标
编译dashgo_rl包，确保所有依赖正确安装。

### 步骤2.1：打开新终端

```bash
# 打开新终端（Ctrl + Alt + T）
```

### 步骤2.2：清理旧编译（推荐）

```bash
# 进入工作空间
cd ~/dashgo_rl_project/catkin_ws

# 清理旧编译
rm -rf build devel
```

### 步骤2.3：安装依赖

```bash
# 确保在env_isaaclab环境中
conda activate env_isaaclab

# 安装rospkg（如果还没有）
pip install rospkg
```

### 步骤2.4：编译工作空间

```bash
# 仍在catkin_ws目录下
cd ~/dashgo_rl_project/catkin_ws

# 激活ROS环境
source /opt/ros/noetic/setup.bash

# 编译（显式指定Python）
catkin_make -DPYTHON_EXECUTABLE=$(which python)
```

**预期输出**:
```
[100%] Built target dashgo_rl
```

### 步骤2.5：刷新环境

```bash
# 刷新环境变量
source devel/setup.bash
```

### 步骤2.6：验证编译结果

```bash
# 检查节点是否可执行
which geo_nav_node.py
# 应该输出: /home/gwh/dashgo_rl_project/catkin_ws/devel/lib/dashgo_rl/geo_nav_node.py

# 检查包路径
rospack find dashgo_rl
# 应该输出: /home/gwh/dashgo_rl_project/catkin_ws/src/dashgo_rl
```

### 🔧 故障排查

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `CMake Error: Could not find rospkg` | 缺少rospkg依赖 | `pip install rospkg` |
| `Python import error: No module named torch` | PyTorch未安装 | `pip install torch==1.10.0` |
| `[xx%] Built target` 之后的错误 | 代码语法错误 | 检查代码修改是否有问题 |

---

## 🌐 阶段3：启动Gazebo仿真（核心步骤）

> **重要**: 这是核心阶段，使用3终端策略保证环境隔离

### 🖥️ 终端分配策略

```
终端 1 (数据监控): 实时查看/cmd_vel话题，观察机器人速度命令
终端 2 (仿真主控): 启动Gazebo + RViz + RL导航节点
终端 3 (故障排查): 保留用于调试、查看TF树、查看日志
```

---

### 🖥️ 终端1：数据监控（先行启动）

**目的**: 提前监控话题，确保机器人连接正常。

#### 步骤3.1-1：打开终端1

按 `Ctrl + Alt + T` 打开第1个终端。

#### 步骤3.1-2：配置环境

```bash
# 复制下面这一整段，一次性粘贴到终端
cd ~/dashgo_rl_project && \
source /opt/ros/noetic/setup.bash && \
source catkin_ws/devel/setup.bash
```

#### 步骤3.1-3：启动话题监控

```bash
# 实时查看速度命令
rostopic echo /cmd_vel
```

**此时应该看到**:
```
WARNING: no messages received and no connected...
```
（这是正常的！等下启动仿真后就会有数据）

**保持这个终端打开，不要关闭！**

---

### 🖥️ 终端2：仿真主控（核心步骤）

**目的**: 启动完整的仿真环境（Gazebo + RViz + RL节点）。

#### 步骤3.2-1：打开终端2

按 `Ctrl + Alt + T` 打开第2个终端。

#### 步骤3.2-2：激活conda环境

```bash
# 你的Isaac Sim在env_isaaclab环境中
conda activate env_isaaclab
```

**预期输出**:
```
(env_isaaclab) gwh@ubuntu:~$
```

#### 步骤3.2-3：配置项目环境

```bash
# 复制下面这一整段，一次性粘贴
cd ~/dashgo_rl_project && \
source /opt/ros/noetic/setup.bash && \
source catkin_ws/devel/setup.bash
```

#### 步骤3.2-4：验证环境（可选）

```bash
# 检查节点路径
which geo_nav_node.py
# 应该输出: /home/gwh/dashgo_rl_project/catkin_ws/devel/lib/dashgo_rl/geo_nav_node.py
```

#### 步骤3.2-5：启动仿真（关键步骤！）

```bash
# 启动Gazebo + RViz + RL导航节点（一键启动）
roslaunch dashgo_rl sim2real_golden.launch
```

---

### 👀 验收标准：应该发生的事情

#### ✅ 检查点1：Gazebo窗口（3-5秒后）

- **看到**: Gazebo仿真器窗口弹出
- **内容**: 显示一个灰色地面（空世界）
- **如果没看到**: 可能需要安装gazebo

```bash
# 如果Gazebo没启动，在新终端检查
sudo apt install ros-noetic-gazebo-ros-pkgs
```

#### ✅ 检查点2：RViz窗口（5-10秒后）

- **看到**: RViz可视化窗口弹出
- **内容**: 应该显示坐标系（TF）
- **如果看不到机器人**: 正常，需要手动添加显示

#### ✅ 检查点3：终端日志（10-15秒后）

**在终端2中，你应该看到以下关键绿字**：

```text
📊 控制频率: 20Hz (dt=0.0500s)
🛡️  加速度限制: Lin=1.0 m/s², Ang=0.6 rad/s²
🔍 正在验证模型输入维度...
✅ 维度检查通过：输入torch.Size([1, 246]) → 输出torch.Size([1, 2])
✅ 模型加载成功
✅ GeoNav Sim2Real 节点启动就绪 (安全增强版 v3.2)
🎯 等待目标点...
```

**🚨 如果看到红色报错**:
- `Dimension Mismatch` → 模型导出有问题，返回阶段1
- `model not found` → TorchScript文件路径错误，检查模型文件
- `No module named 'torch'` → Python环境问题，检查conda环境

#### ✅ 检查点4：话题数据（在终端1）

**切换到终端1**，应该看到类似输出：

```text
linear:
  x: 0.0  # 初始为0，等发送目标后会变化
  y: 0.0
  z: 0.0
angular:
  x: 0.0
  y: 0.0
  z: 0.0
---
```

**如果看到上面的内容，说明系统正常！**

---

## 🕹️ 阶段4：发送导航目标（5分钟）

### 目标
通过RViz发送目标点，观察机器人是否能够导航。

### 步骤4.1：配置RViz显示

**在RViz窗口中**：

#### 添加机器人模型

1. 点击左侧 **"Add"** 按钮
2. 选择 **"RobotModel"**
3. 点击 **"OK"**

#### 添加激光雷达显示

1. 点击 **"Add"**
2. 选择 **"By topic"**
3. 找到 **"/scan"** → **"LaserScan"**
4. 点击 **"OK"**

#### 添加TF坐标系

1. 点击 **"Add"**
2. 选择 **"TF"**
3. 点击 **"OK"**

### 步骤4.2：停止话题监控

**在终端1中**：
按 `Ctrl + C` 停止 `rostopic echo`（保持终端打开）。

### 步骤4.3：发送导航目标

1. **在RViz顶部工具栏**，找到 **"2D Nav Goal"** 工具（绿色箭头图标）

2. **点击该工具**（工具栏会高亮显示）

3. **在3D视图中**:
   - 将鼠标移到机器人前方 **1-2米** 的位置
   - **按住鼠标左键**（点击目标点）
   - **拖动鼠标**（设置朝向，让箭头指向你想让机器人前进的方向）
   - **松开鼠标**（发送目标）

### 步骤4.4：观察机器人运动

#### 在终端1中：重新启动话题监控

```bash
# 重新启动话题监控
rostopic echo /cmd_vel
```

**你应该看到**:
```text
linear:
  x: 0.15  # 机器人前进
  y: 0.0
  z: 0.0
angular:
  x: 0.0
  y: 0.0
  z: 0.3  # 机器人转向
---
```
数值会持续跳动（控制频率20Hz）

#### 在Gazebo窗口中

- 机器人开始移动
- 速度平滑，没有突然弹射
- 如果有障碍物，机器人会尝试避开

#### 在终端2中（日志）

```text
🎯 收到新目标: (1.50, 0.80)
```

---

## ✅ 阶段5：验证与调优（5分钟）

### 目的
验证部署是否成功，机器人是否按预期工作。

### 5.1 机器人运动验证

- [ ] 机器人向目标点移动（不是原地转圈）
- [ ] 速度平滑，没有剧烈抖动
- [ ] 接近目标时自动减速
- [ ] 到达目标后停止（距离 < 0.2m）

### 5.2 数据标准验证

在新终端中执行：

```bash
# 检查话题发布频率
rostopic hz /cmd_vel
# 应该约为：20 Hz

# 查看速度范围
rostopic echo /cmd_vel | grep "x:"
# 线速度范围：0.0 ~ 0.3 m/s
# 角速度范围：-1.0 ~ 1.0 rad/s
```

### 5.3 安全机制验证

- [ ] 机器人不倒车（倒车会被禁止）
- [ ] 加速度平滑，没有突然加速
- [ ] 没有出现红色错误日志

### 5.4 成功标准

如果满足以下所有条件，说明部署成功：

| 检查项 | 标准 | 状态 |
|--------|------|------|
| 机器人运动 | 向目标点移动，不转圈 | ✅/❌ |
| 速度平滑 | 无剧烈抖动 | ✅/❌ |
| 到达目标 | 距离 < 0.2m | ✅/❌ |
| 控制频率 | 约20Hz | ✅/❌ |
| 速度范围 | 线速度0-0.3，角速度±1.0 | ✅/❌ |
| 无错误日志 | 终端无红色报错 | ✅/❌ |

---

## 🚨 紧急故障排查

### 如果机器人不动

**检查1**: 目标是否发送
```bash
rostopic echo /move_base_simple/goal -n 1
# 发送目标后应该看到数据
```

**检查2**: TF树是否正常
```bash
rosrun tf view_frames
# 或
rosrun rqt_tf_tree rqt_tf_tree
# 应该看到: odom → base_link → laser_link
```

**检查3**: 雷达数据
```bash
rostopic echo /scan -n 1
# 应该看到雷达距离数据
```

### 如果机器人原地转圈

**原因**: 训练未收敛或模型过旧

**解决**:
```bash
# 检查训练曲线
tensorboard --logdir=logs

# 使用最新模型重新导出
cd ~/dashgo_rl_project
conda activate env_isaaclab
python export_torchscript.py --checkpoint logs/model_900.pt
```

### 如果速度过慢

**解决**: 修改launch文件参数

```bash
# 编辑launch文件
nano ~/dashgo_rl_project/catkin_ws/src/dashgo_rl/launch/sim2real_golden.launch

# 找到并修改：
# <arg name="max_lin_vel" default="0.5" />  # 从0.3改为0.5

# 重启仿真
# 在终端2按Ctrl+C，然后重新执行
roslaunch dashgo_rl sim2real_golden.launch
```

### 如果维度检查失败

**错误信息**:
```text
💀 致命错误：模型维度不匹配！
```

**解决**:
```bash
# 重新导出模型
cd ~/dashgo_rl_project
conda activate env_isaaclab
python export_torchscript.py --checkpoint logs/model_900.pt

# 验证导出
ls -lh catkin_ws/src/dashgo_rl/models/policy_torchscript.pt
# 应该显示约1.8MB
```

---

## 📊 性能基准参考

### 预期性能指标

| 指标 | 仿真环境 | 说明 |
|------|---------|------|
| 控制频率 | 20Hz | dt=0.05s |
| 最大线速度 | 0.3 m/s | launch参数可调 |
| 最大角速度 | 1.0 rad/s | launch参数可调 |
| 线加速度限制 | 1.0 m/s² | v3.2-Safe新增 |
| 角加速度限制 | 0.6 rad/s² | v3.2-Safe修正 |
| 导航成功率（3米） | > 80% | 空旷环境 |
| 平均到达时间（3米） | < 15s | 无障碍物 |

### v3.2-Safe安全增强特性

1. **维度熔断检查**: 启动时验证模型输入维度
2. **动态控制频率**: 从launch文件读取control_rate
3. **加速度数学修正**: 修正了角加速度计算错误（2.0→0.6）
4. **模型路径优化**: 使用rospkg动态查找，跨平台兼容
5. **倒车禁止**: 绝对倒车被禁止（安全保护）

---

## 🎓 高级操作

### 选项A：修改控制频率

如果发现机器人响应不流畅，可以调整控制频率：

```xml
<!-- catkin_ws/src/dashgo_rl/launch/sim2real_golden.launch -->
<arg name="control_rate" default="10" />  <!-- 从20Hz改为10Hz -->
```

### 选项B：添加障碍物测试

在Gazebo中：
1. 点击顶部"Edit"菜单
2. 选择"Building Editor"
3. 添加墙壁或障碍物
4. 保存并重新发送目标点

### 选项C：查看TF树

```bash
# 在终端3中
rosrun rqt_tf_tree rqt_tf_tree
# 应该看到完整的TF树
```

---

## 📝 常用命令速查表

### 一键启动（推荐）

```bash
# 终端1：数据监控
cd ~/dashgo_rl_project && \
source /opt/ros/noetic/setup.bash && \
source catkin_ws/devel/setup.bash && \
rostopic echo /cmd_vel

# 终端2：启动仿真
conda activate env_isaaclab && \
cd ~/dashgo_rl_project && \
source /opt/ros/noetic/setup.bash && \
source catkin_ws/devel/setup.bash && \
roslaunch dashgo_rl sim2real_golden.launch
```

### 重新编译

```bash
cd ~/dashgo_rl_project/catkin_ws
source /opt/ros/noetic/setup.bash
catkin_make -DPYTHON_EXECUTABLE=$(which python)
source devel/setup.bash
```

### 重新导出模型

```bash
cd ~/dashgo_rl_project
conda activate env_isaaclab
python export_torchscript.py --checkpoint logs/model_900.pt
```

### 查看所有话题

```bash
source ~/dashgo_rl_project/catkin_ws/devel/setup.bash
rostopic list
```

### 查看节点图

```bash
rqt_graph
```

---

## 🚨 紧急停止方法

如果机器人失控，使用以下任一方法：

### 方法1：发布零速度

```bash
rostopic pub /cmd_vel geometry_msgs/Twist '{linear: {x: 0.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}'
```

### 方法2：Ctrl+C停止RL节点

**在终端2（仿真主控）** 按 `Ctrl + C`

### 方法3：杀死所有ROS节点

```bash
rosnode kill -a
```

---

## 📚 相关文档

### 详细参考文档

- **代码安全增强修改总结**: `docs/01-部署指南/代码安全增强修改总结_v3.2-Safe_2026-01-28.md`
- **代码接口检查报告**: `docs/03-问题分析/代码接口对应关系检查报告_2026-01-28.md`
- **架构师建议分析**: `docs/03-问题分析/架构师建议分析与优化方案_2026-01-28.md`

### 技术规范

- **Isaac Lab开发铁律**: `docs/05-协议规范/isaac-lab-development-iron-rules.md`
- **项目特定规则**: `docs/05-协议规范/project-specific-rules.md`

---

## 🎯 下一步

完成仿真测试后，可以进行：

1. **性能调优**: 调整加速度限制、控制频率
2. **障碍物测试**: 在Gazebo中添加障碍物
3. **长期训练**: 继续训练模型提高成功率
4. **实车部署**: 使用 `real_control.launch` 连接真实机器人

---

## 📞 获取帮助

如果遇到问题：

1. **查看终端日志**: 红色报错会给出明确提示
2. **查阅故障排查章节**: 本文档包含详细的错误代码表
3. **查看相关文档**: 上述相关文档有详细的技术说明
4. **检查环境**: 确认conda环境、ROS环境、模型文件都正常

---

**文档版本**: 超级完整版 v1.0
**创建时间**: 2026-01-28 20:20:00
**作者**: Isaac Sim Architect + Claude Code
**状态**: ✅ 已验证，包含v3.2-Safe所有安全增强

**准备好开始了吗？让我们从阶段0开始吧！** 🚀
