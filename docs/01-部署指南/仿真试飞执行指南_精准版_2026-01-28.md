# DashGo 仿真试飞执行指南 - 精准版

> **创建时间**: 2026-01-28 16:00:00
> **针对环境**: Ubuntu 20.04 + Isaac Sim 4.5 + ROS Noetic
> **作者**: Isaac Sim Architect + Claude Code
> **项目路径**: `/home/gwh/dashgo_rl_project`

---

## 🎯 任务概述

**目标**: 在 Gazebo 仿真环境中测试 RL 导航策略，验证端到端部署流程。

**预计时间**: 10-15 分钟

**前置条件**:
- ✅ 训练完成（最新模型: `model_900.pt`）
- ✅ TorchScript 模型已导出（1.8MB）
- ✅ ROS 工作空间已编译

---

## 🖥️ 终端分配策略

我们将使用 **3 个独立终端** 来保证环境隔离：

```
终端 1 (数据监控): 监控话题数据，观察机器人状态
终端 2 (仿真主控): 启动 Gazebo + RViz + RL 节点
终端 3 (故障排查): 保留用于调试和查看日志
```

---

## 🖥️ 终端 1：数据监控（先行启动）

**目的**: 提前监控话题，确保机器人连接正常。

### 步骤 1.1：打开新终端

按 `Ctrl + Alt + T` 打开第 1 个终端。

### 步骤 1.2：配置 ROS 环境

```bash
# 复制下面这一整段，一次性粘贴到终端
cd ~/dashgo_rl_project && \
source /opt/ros/noetic/setup.bash && \
source catkin_ws/devel/setup.bash
```

**预期输出**: 无错误，终端正常返回。

### 步骤 1.3：启动话题监控

```bash
# 实时查看速度命令（机器人会在这里显示速度）
rostopic echo /cmd_vel
```

**此时应该看到**:
```
WARNING: no messages received and no connected...
```
（这是正常的！等下启动仿真后就会有数据）

**保持这个终端打开，不要关闭！**

---

## 🖥️ 终端 2：仿真主控（核心步骤）

**目的**: 启动完整的仿真环境。

### 步骤 2.1：打开第 2 个终端

按 `Ctrl + Alt + T` 打开第 2 个终端。

### 步骤 2.2：激活 conda 环境

```bash
# 你的 Isaac Sim 在 env_isaaclab 环境中
conda activate env_isaaclab
```

**预期输出**:
```
(env_isaaclab) gwh@ubuntu:~$
```

### 步骤 2.3：配置项目环境

```bash
# 复制下面这一整段，一次性粘贴
cd ~/dashgo_rl_project && \
source /opt/ros/noetic/setup.bash && \
source catkin_ws/devel/setup.bash
```

**验证环境**（可选）:
```bash
# 检查节点路径
which geo_nav_node.py
# 应该输出: /home/gwh/dashgo_rl_project/catkin_ws/devel/lib/dashgo_rl/geo_nav_node.py
```

### 步骤 2.4：启动仿真（关键步骤！）

```bash
# 启动 Gazebo + RViz + RL 导航节点
roslaunch dashgo_rl sim2real_golden.launch
```

---

## 👀 架构师的验收标准

**此时应该发生的事情**（按顺序）：

### ✅ 检查点 1：Gazebo 窗口（3-5 秒后）
- **看到**: Gazebo 仿真器窗口弹出
- **内容**: 显示一个灰色地面（空世界）
- **如果没看到**: 检查是否安装了 `gazebo11`

### ✅ 检查点 2：RViz 窗口（5-10 秒后）
- **看到**: RViz 可视化窗口弹出
- **内容**: 应该显示机器人模型或坐标系
- **如果没看到**: 正常，RViz 配置可能需要手动调整

### ✅ 检查点 3：终端日志（10-15 秒后）

**在终端 2 中，你应该看到以下关键绿字**：

```text
📊 控制频率: 20Hz (dt=0.0500s)
🛡️  加速度限制: Lin=1.0 m/s², Ang=0.6 rad/s²
🔍 正在验证模型输入维度...
✅ 维度检查通过：输入torch.Size([1, 246]) → 输出torch.Size([1, 2])
✅ 模型加载成功
✅ GeoNav Sim2Real 节点启动就绪 (安全增强版 v3.2)
🎯 等待目标点...
```

**🚨 如果看到红色报错**:
- `Dimension Mismatch` → 模型导出有问题
- `model not found` → TorchScript 文件路径错误
- `No module named 'torch'` → Python 环境问题

### ✅ 检查点 4：话题数据（在终端 1）

**切换到终端 1**，应该看到类似输出：
```text
linear:
  x: 0.0  # 初始为0，等发送目标后会变化
  y: 0.0
  z: 0.0
angular:
  x: 0.0
  y: 0.0
  z: 0.0
---
```

**如果看到上面的内容，说明系统正常！**

---

## 🕹️ 终端 1（继续）：发送导航指令

**目的**: 给机器人发送目标点，观察它是否能导航。

### 步骤 3.1：停止话题监控

**在终端 1 中**：
按 `Ctrl + C` 停止 `rostopic echo`（保持终端打开）。

### 步骤 3.2：切换到 RViz 窗口

**在 RViz 窗口中**：

1. **添加机器人模型显示**（如果看不到机器人）:
   - 点击左侧 **"Add"** 按钮
   - 选择 **"RobotModel"**
   - 点击 **"OK"**

2. **添加激光雷达显示**（看到障碍物）:
   - 点击 **"Add"**
   - 选择 **"By topic"**
   - 找到 **"/scan"** → **"LaserScan"**
   - 点击 **"OK"**

3. **添加 TF 坐标系**（调试用）:
   - 点击 **"Add"**
   - 选择 **"TF"**
   - 点击 **"OK"**

### 步骤 3.3：发送导航目标

1. **在 RViz 顶部工具栏**，找到 **"2D Nav Goal"** 工具（绿色箭头图标）

2. **点击该工具**（工具栏会高亮显示）

3. **在 3D 视图中**:
   - 将鼠标移到机器人前方 **1-2 米** 的位置
   - **按住鼠标左键**（点击目标点）
   - **拖动鼠标**（设置朝向，让箭头指向你想让机器人前进的方向）
   - **松开鼠标**（发送目标）

### 步骤 3.4：观察机器人运动

**在终端 1 中**，重新启动话题监控：
```bash
rostopic echo /cmd_vel
```

**你应该看到**:
- `linear.x: 0.15` ~ `0.25`（机器人前进）
- `angular.z: 0.2` ~ `0.5`（机器人转向）
- 数值持续跳动（控制频率 20Hz）

**在 Gazebo 窗口中**:
- 机器人开始移动
- 速度平滑，没有突然弹射
- 如果有障碍物，机器人会尝试避开

**在终端 2 中**（日志）:
```text
🎯 收到新目标: (1.50, 0.80)
```

---

## ✅ 成功标准

如果满足以下所有条件，说明部署成功：

### 🎯 行为标准
- [ ] 机器人向目标点移动（不是原地转圈）
- [ ] 速度平滑，没有剧烈抖动
- [ ] 接近目标时自动减速
- [ ] 到达目标后停止（距离 < 0.2m）

### 📊 数据标准
- [ ] `/cmd_vel` 发布频率约 20Hz
- [ ] 线速度范围：0.0 ~ 0.3 m/s
- [ ] 角速度范围：-1.0 ~ 1.0 rad/s

### 🛡️ 安全标准
- [ ] 机器人不倒车（倒车会被禁止）
- [ ] 加速度平滑，没有突然加速
- [ ] 没有出现红色错误日志

---

## 🚨 故障排查（终端 3 专用）

**打开第 3 个终端**，用于调试。

### 问题 1：Gazebo 窗口不打开

**检查**:
```bash
# 在终端 3 中
rospack find gazebo_ros
# 如果输出路径，说明已安装
# 如果报错，需要安装：
sudo apt install ros-noetic-gazebo-ros-pkgs ros-noetic-gazebo-ros-control
```

### 问题 2：RViz 窗口空白

**解决**: RViz 配置问题，可以手动添加显示项（参考步骤 3.2）

### 问题 3：机器人不动

**检查 1**: 话题是否发布
```bash
rostopic list | grep cmd_vel
# 应该输出: /cmd_vel
```

**检查 2**: 目标是否发送
```bash
rostopic echo /move_base_simple/goal -n 1
# 发送目标后应该看到数据
```

**检查 3**: TF 树是否正常
```bash
rosrun tf view_frames
# 或
rosrun rqt_tf_tree rqt_tf_tree
# 应该看到: odom → base_link → laser_link
```

### 问题 4：维度检查失败

**错误信息**:
```
💀 致命错误：模型维度不匹配！
```

**解决**:
```bash
# 重新导出模型
cd ~/dashgo_rl_project
conda activate env_isaaclab
python export_torchscript.py --checkpoint logs/model_900.pt

# 验证导出
ls -lh catkin_ws/src/dashgo_rl/models/policy_torchscript.pt
# 应该显示约 1.8MB
```

### 问题 5：Python 模块缺失

**错误信息**:
```
No module named 'torch'
```

**解决**:
```bash
# 在 env_isaaclab 环境中
conda activate env_isaaclab
pip install torch rospkg
```

---

## 🔧 高级调试（如果需要）

### 查看 TF 树
```bash
# 在终端 3
rosrun rqt_tf_tree rqt_tf_tree
```
**预期**: 看到完整的 TF 树，包含 `odom`, `base_link`, `laser_link`

### 查看雷达数据
```bash
rostopic echo /scan -n 1
```
**预期**: 看到雷达距离数据（ranges 数组）

### 查看里程计
```bash
rostopic echo /odom -n 1
```
**预期**: 看到机器人位置和速度

### 手动发布速度命令（测试用）
```bash
rostopic pub /cmd_vel geometry_msgs/Twist '{linear: {x: 0.1}, angular: {z: 0.0}}' -1
```
**效果**: 机器人应该以 0.1 m/s 前进（按 Ctrl+C 停止）

---

## 🎓 理解控制流程

```
RViz (2D Nav Goal)
    ↓ 发布目标点
/move_base_simple/goal (PoseStamped)
    ↓ RL 节点接收
geo_nav_node.py (v3.2-Safe)
    ↓ 模型推理
TorchScript 模型 (policy_torchscript.pt)
    ↓ 输出动作 [-1, 1]
    ↓ 缩放 + 加速度限制
/cmd_vel (Twist)
    ↓ Gazebo 机器人执行
机器人运动
```

**关键参数**:
- 控制频率: 20Hz
- 最大线速度: 0.3 m/s
- 最大角速度: 1.0 rad/s
- 线加速度限制: 1.0 m/s²
- 角加速度限制: 0.6 rad/s²

---

## 📝 日志记录模板

**如果遇到问题，请记录以下信息**：

```markdown
### 问题描述
[简要描述问题]

### 复现步骤
1.
2.
3.

### 错误信息
```text
[从终端复制的完整错误日志]
```

### 环境信息
- Ubuntu 版本: `lsb_release -a`
- ROS 版本: `rosversion -d`
- Python 版本: `python --version`
- PyTorch 版本: `python -c "import torch; print(torch.__version__)"`

### 已尝试的解决方法
- [ ] 重新导出模型
- [ ] 重新编译 ROS
- [ ] 检查话题连接
```

---

## 🎯 下一步

成功完成仿真测试后：

1. **性能优化**: 调整 launch 文件中的速度/加速度参数
2. **障碍物测试**: 在 Gazebo 中添加障碍物，测试避障能力
3. **实车部署**: 使用 `real_control.launch` 连接真实机器人
4. **继续训练**: 如果性能不理想，继续训练模型

---

## 📚 相关命令速查

### 终端切换快捷键
- `Alt + 1`: 切换到终端 1
- `Alt + 2`: 切换到终端 2
- `Alt + 3`: 切换到终端 3

### 停止所有进程
```bash
# 在终端 2（仿真主控）按 Ctrl+C
# 这会停止 Gazebo、RViz、RL 节点
```

### 清理 ROS 节点
```bash
rosnode kill -a
# 杀死所有 ROS 节点
```

### 重新启动（快速）
```bash
# 在终端 2
cd ~/dashgo_rl_project
conda activate env_isaaclab
source /opt/ros/noetic/setup.bash
source catkin_ws/devel/setup.bash
roslaunch dashgo_rl sim2real_golden.launch
```

---

**文档版本**: v1.0
**最后更新**: 2026-01-28 16:00:00
**针对环境**:
- 项目路径: `/home/gwh/dashgo_rl_project`
- Conda 环境: `env_isaaclab`
- 最新模型: `model_900.pt`
- TorchScript 模型: `policy_torchscript.pt` (1.8MB)

**准备好了吗？让我们开始仿真试飞！🚀**
