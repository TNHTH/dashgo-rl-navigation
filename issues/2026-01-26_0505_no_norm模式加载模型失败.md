# no_norm æ¨¡å¼åŠ è½½æ¨¡å‹å¤±è´¥é—®é¢˜

> **å‘ç°æ—¶é—´**: 2026-01-26 05:05
> **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡ï¼ˆé˜»å¡å½’ä¸€åŒ–ä¸­æ¯’æµ‹è¯•ï¼‰
> **çŠ¶æ€**: âœ… å·²è§£å†³
> **ç›¸å…³æ–‡ä»¶**: `debug_play.py`

---

## ğŸ” é—®é¢˜æè¿°

**é”™è¯¯ç°è±¡**:
è¿è¡Œ `--test no_norm` æµ‹è¯•æ—¶ï¼ŒåŠ è½½æ¨¡å‹é˜¶æ®µæŠ¥é”™ï¼š

```bash
python debug_play.py --test no_norm --num_envs 1
```

**é”™è¯¯ä¿¡æ¯**:
```python
RuntimeError: Error(s) in loading state_dict for ActorCritic:
    Unexpected key(s) in state_dict:
    "actor_obs_normalizer._mean"
    "actor_obs_normalizer._var"
    "actor_obs_normalizer._std"
    "actor_obs_normalizer.count"
    "critic_obs_normalizer._mean"
    "critic_obs_normalizer._var"
    "critic_obs_normalizer._std"
    "critic_obs_normalizer.count"
```

**å½±å“èŒƒå›´**:
- âœ… `--test straight_line`: æ­£å¸¸ï¼ˆå¼€å¯å½’ä¸€åŒ–ï¼‰
- âœ… `--test print_obs`: æ­£å¸¸ï¼ˆå¼€å¯å½’ä¸€åŒ–ï¼‰
- âŒ `--test no_norm`: **æ— æ³•è¿è¡Œ**ï¼ˆå…³é—­å½’ä¸€åŒ–ï¼‰

---

## ğŸ”¬ æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜æ ¹æºï¼šè®­ç»ƒä¸æ¨ç†çš„å½’ä¸€åŒ–é…ç½®ä¸åŒ¹é…

**è®­ç»ƒæ—¶**ï¼ˆ`train_v2.py`ï¼‰:
```python
policy = ActorCritic(
    obs=obs_dict,
    obs_groups=obs_groups,
    num_actions=num_actions,
    actor_hidden_dims=[512, 256, 128],
    critic_hidden_dims=[512, 256, 128],
    activation='elu',
    init_noise_std=1.0,
    # âœ… å¼€å¯å½’ä¸€åŒ–
    actor_obs_normalization=True,   # å¼€å¯
    critic_obs_normalization=True,  # å¼€å¯
).to(device)

# ä¿å­˜æ—¶åŒ…å«å½’ä¸€åŒ–å±‚å‚æ•°
torch.save({
    'model_state_dict': policy.state_dict(),  # åŒ…å« normalizer
    # ...
}, checkpoint_path)
```

**æ¨ç†æ—¶ - no_normæ¨¡å¼**ï¼ˆ`debug_play.py`ï¼‰:
```python
# æ ¹æ®æµ‹è¯•ç±»å‹å†³å®šæ˜¯å¦å¼€å¯å½’ä¸€åŒ–
enable_norm = (args_cli.test != "no_norm")

policy = ActorCritic(
    obs=obs_dict,
    obs_groups=obs_groups,
    num_actions=num_actions,
    # ...
    # âŒ å…³é—­å½’ä¸€åŒ–
    actor_obs_normalization=enable_norm,   # False
    critic_obs_normalization=enable_norm,  # False
).to(device)

# å°è¯•åŠ è½½åŒ…å«å½’ä¸€åŒ–å‚æ•°çš„æƒé‡
loaded_dict = torch.load(ckpt_path, map_location=device)
policy.load_state_dict(loaded_dict['model_state_dict'])  # âŒ æŠ¥é”™ï¼
```

### ä¸ºä»€ä¹ˆä¼šå†²çªï¼Ÿ

1. **è®­ç»ƒæ—¶**: ActorCritic åˆ›å»ºäº†å½’ä¸€åŒ–å±‚ï¼ˆ`actor_obs_normalizer`, `critic_obs_normalizer`ï¼‰
   - è¿™äº›å±‚æœ‰å¯å­¦ä¹ å‚æ•°ï¼š`_mean`, `_var`, `_std`, `count`
   - ä¿å­˜åˆ° checkpoint æ—¶åŒ…å«è¿™äº›å‚æ•°

2. **æ¨ç†æ—¶ - no_norm**: ActorCritic **æ²¡æœ‰åˆ›å»º**å½’ä¸€åŒ–å±‚
   - å› ä¸º `actor_obs_normalization=False`
   - ç½‘ç»œç»“æ„ä¸­ä¸å­˜åœ¨ `actor_obs_normalizer` ç­‰å±æ€§

3. **åŠ è½½æƒé‡æ—¶**: PyTorch å‘ç° state_dict ä¸­æœ‰å½’ä¸€åŒ–å‚æ•°ï¼Œä½†ç½‘ç»œä¸­æ²¡æœ‰å¯¹åº”çš„å±‚
   - æŠ¥é”™ï¼š`Unexpected key(s) in state_dict`

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### å®æ–½çš„ä¿®å¤ï¼ˆå·²åº”ç”¨ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `debug_play.py` (ç¬¬146-159è¡Œ)

**ä¿®å¤é€»è¾‘**:
```python
loaded_dict = torch.load(ckpt_path, map_location=device)
model_state_dict = loaded_dict['model_state_dict']

# [ä¿®å¤] å¦‚æœå…³é—­å½’ä¸€åŒ–ï¼Œåˆ é™¤å½’ä¸€åŒ–å±‚å‚æ•°ï¼ˆé¿å…åŠ è½½é”™è¯¯ï¼‰
if not enable_norm:
    # æ‰¾åˆ°æ‰€æœ‰åŒ…å« 'normalizer' çš„é”®
    keys_to_remove = [k for k in model_state_dict.keys() if 'normalizer' in k]
    # åˆ é™¤è¿™äº›é”®
    for key in keys_to_remove:
        del model_state_dict[key]
    if keys_to_remove:
        print(f"[INFO] å·²åˆ é™¤ {len(keys_to_remove)} ä¸ªå½’ä¸€åŒ–å±‚å‚æ•°ï¼ˆå› å…³é—­å½’ä¸€åŒ–ï¼‰")

policy.load_state_dict(model_state_dict)
policy.eval()
```

**ä¿®å¤æ•ˆæœ**:
- âœ… `--test straight_line`: æ­£å¸¸è¿è¡Œï¼ˆä¿ç•™å½’ä¸€åŒ–å‚æ•°ï¼‰
- âœ… `--test print_obs`: æ­£å¸¸è¿è¡Œï¼ˆä¿ç•™å½’ä¸€åŒ–å‚æ•°ï¼‰
- âœ… `--test no_norm`: **ç°åœ¨å¯ä»¥æ­£å¸¸è¿è¡Œ**ï¼ˆåˆ é™¤å½’ä¸€åŒ–å‚æ•°ï¼‰

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### RSL-RL çš„å½’ä¸€åŒ–å±‚å®ç°

**RunningMeanStd æœºåˆ¶**:
```python
class RunningMeanStd:
    def __init__(self, shape, epsilon=1e-4):
        self._mean = torch.zeros(shape)  # å‡å€¼
        self._var = torch.ones(shape)    # æ–¹å·®
        self._std = torch.ones(shape)    # æ ‡å‡†å·®
        self.count = 0                   # æ ·æœ¬è®¡æ•°

    def update(self, x):
        # æ›´æ–°ç»Ÿè®¡é‡ï¼ˆåœ¨çº¿ç®—æ³•ï¼‰
        batch_mean = x.mean(dim=0)
        batch_var = x.var(dim=0)
        batch_count = x.size(0)

        # æ›´æ–°å…¨å±€ç»Ÿè®¡é‡
        delta = batch_mean - self._mean
        total_count = self.count + batch_count

        new_mean = self._mean + delta * batch_count / total_count
        M_a = self._var * self.count
        M_b = batch_var * batch_count
        M2 = M_a + M_b + delta**2 * self.count * batch_count / total_count
        new_var = M2 / total_count

        self._mean = new_mean
        self._var = new_var
        self._std = torch.sqrt(new_var + epsilon)
        self.count = total_count
```

**å½’ä¸€åŒ–è¿‡ç¨‹**:
```python
normalized_obs = (obs - mean) / (std + epsilon)
```

### ä¸ºä»€ä¹ˆè®­ç»ƒåˆæœŸçš„ç»Ÿè®¡é‡ä¼š"ä¸­æ¯’"ï¼Ÿ

**è®­ç»ƒåˆæœŸ**ï¼ˆå‰100-200 iterï¼‰:
```
Episode 1-10: æœºå™¨äººç–¯ç‹‚å‘æŠ–åˆ·åˆ†
  lin_vel: [-8.0, +7.5, -9.2, +8.8, ...]  â† æç«¯å€¼
  ang_vel: [-6.5, +7.0, -7.3, +6.9, ...]  â† æç«¯å€¼

RunningMeanStd è®°å½•ï¼š
  mean â‰ˆ 0.0 (æ­£è´ŸæŠµæ¶ˆ)
  var  â‰ˆ 50.0 (æç«¯æ–¹å·®ï¼)
  std  â‰ˆ 7.0 (æç«¯æ ‡å‡†å·®ï¼)
```

**è®­ç»ƒä¸­æœŸ**ï¼ˆ200-1000 iterï¼‰:
```
ç­–ç•¥å­¦ä¼šæ­£å¸¸å¯¼èˆªï¼š
  lin_vel: [0.2, 0.25, 0.18, ...]  â† æ­£å¸¸å€¼
  ang_vel: [0.5, -0.3, 0.4, ...]   â† æ­£å¸¸å€¼

ä½†å½’ä¸€åŒ–ç»Ÿè®¡é‡å·²ç»è„äº†ï¼š
  mean â‰ˆ 0.0 (è¿˜ç®—æ­£å¸¸)
  var  â‰ˆ 20.0 (ä»ç„¶å¾ˆé«˜ï¼)
  std  â‰ˆ 4.5 (ä»ç„¶å¾ˆé«˜ï¼)
```

**æ¨ç†æ—¶**:
```python
# æ­£å¸¸è§‚æµ‹
obs = 0.1  # m/s

# å½’ä¸€åŒ–å
normalized_obs = (0.1 - 0.0) / 4.5 = 0.022  # è¢«ä¸¥é‡ç¼©å°ï¼

# ç¥ç»ç½‘ç»œè®¤ä¸ºæ˜¯"å¼‚å¸¸å°"çš„é€Ÿåº¦
# è¾“å‡ºæç«¯åŠ¨ä½œæ¥"çº æ­£"è¿™ä¸ª"å¼‚å¸¸"
action_v = 9.0  # m/s (è¯•å›¾åŠ é€Ÿï¼)
action_w = -7.5 # rad/s (è¯•å›¾è½¬å‘ï¼)
```

---

## ğŸ¯ ç»éªŒæ•™è®­

### 1. è®­ç»ƒåˆæœŸçš„"åˆ·åˆ†"è¡Œä¸ºæ±¡æŸ“å½’ä¸€åŒ–ç»Ÿè®¡é‡

**é—®é¢˜**: PPOè®­ç»ƒåˆæœŸï¼Œç­–ç•¥ä¸ºäº†å¿«é€Ÿè·å¾—å¥–åŠ±ï¼Œä¼šå­¦ä¼š"ç–¯ç‹‚å‘æŠ–"
- é«˜é¢‘æ­£åå‘åˆ‡æ¢
- æç«¯é€Ÿåº¦å€¼
- å¯¼è‡´å½’ä¸€åŒ–ç»Ÿè®¡é‡å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**:
- åœ¨è®­ç»ƒè„šæœ¬ä¸­æ·»åŠ **åŠ¨ä½œè£å‰ª**ï¼ˆå·²åœ¨ `dashgo_env_v2.py` ä¸­å®ç°ï¼‰
- è€ƒè™‘åœ¨è®­ç»ƒåˆæœŸï¼ˆå‰100 iterï¼‰ç¦ç”¨å½’ä¸€åŒ–ç»Ÿè®¡é‡æ›´æ–°
- æˆ–è€…è®¾ç½® `init_noise_std=1.0` å¢åŠ æ¢ç´¢ï¼Œé¿å…å¿«é€Ÿæ”¶æ•›åˆ°å±€éƒ¨æœ€ä¼˜

### 2. æ¨ç†æ—¶éœ€è¦çµæ´»å¤„ç†å½’ä¸€åŒ–å±‚

**é—®é¢˜**: ä¸åŒæµ‹è¯•æ¨¡å¼éœ€è¦ä¸åŒçš„å½’ä¸€åŒ–é…ç½®
- `straight_line` / `print_obs`: éœ€è¦å½’ä¸€åŒ–ï¼ˆä¸è®­ç»ƒä¸€è‡´ï¼‰
- `no_norm`: ä¸éœ€è¦å½’ä¸€åŒ–ï¼ˆæµ‹è¯•å½’ä¸€åŒ–æ˜¯å¦ä¸­æ¯’ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- åŠ è½½æƒé‡å‰æ£€æŸ¥å½’ä¸€åŒ–é…ç½®
- å¦‚æœé…ç½®ä¸åŒ¹é…ï¼Œåˆ é™¤å¯¹åº”çš„å‚æ•°
- é¿å…åŠ è½½é”™è¯¯

### 3. è°ƒè¯•å·¥å…·çš„é²æ£’æ€§è®¾è®¡

**é—®é¢˜**: è°ƒè¯•è„šæœ¬éœ€è¦æ”¯æŒå¤šç§æµ‹è¯•æ¨¡å¼ï¼Œä½†æ¯ç§æ¨¡å¼çš„è¦æ±‚ä¸åŒ

**è®¾è®¡åŸåˆ™**:
```python
# 1. æ ¹æ®æµ‹è¯•æ¨¡å¼åŠ¨æ€é…ç½®
enable_norm = (args_cli.test != "no_norm")

# 2. åŠ è½½æ—¶å¤„ç†ä¸åŒ¹é…
if not enable_norm:
    # åˆ é™¤å½’ä¸€åŒ–å‚æ•°
    keys_to_remove = [k for k in model_state_dict.keys() if 'normalizer' in k]
    for key in keys_to_remove:
        del model_state_dict[key]

# 3. æ‰“å°é…ç½®ä¿¡æ¯
print(f"[INFO] å½’ä¸€åŒ–çŠ¶æ€: {'å¼€å¯' if enable_norm else 'å…³é—­'}")
if keys_to_remove:
    print(f"[INFO] å·²åˆ é™¤ {len(keys_to_remove)} ä¸ªå½’ä¸€åŒ–å±‚å‚æ•°")
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **æ’æŸ¥æŒ‡å—**: `issues/2026-01-26_0440_é†‰æ±‰èµ°è·¯é—®é¢˜æ’æŸ¥æŒ‡å—.md`
- **æ’æŸ¥è®°å½•**: `issues/2026-01-26_0450_é†‰æ±‰èµ°è·¯é—®é¢˜æ’æŸ¥è®°å½•.md`
- **è°ƒè¯•è„šæœ¬**: `debug_play.py`

---

## âœ… éªŒè¯æ–¹æ³•

**æµ‹è¯•å‘½ä»¤**:
```bash
# æµ‹è¯•1: éªŒè¯ straight_line æ¨¡å¼ï¼ˆå¼€å¯å½’ä¸€åŒ–ï¼‰
python debug_play.py --test straight_line --num_envs 1 --num_episodes 1

# æµ‹è¯•2: éªŒè¯ print_obs æ¨¡å¼ï¼ˆå¼€å¯å½’ä¸€åŒ–ï¼‰
python debug_play.py --test print_obs --num_envs 1 --num_episodes 1

# æµ‹è¯•3: éªŒè¯ no_norm æ¨¡å¼ï¼ˆå…³é—­å½’ä¸€åŒ–ï¼‰
python debug_play.py --test no_norm --num_envs 1 --num_episodes 1
```

**é¢„æœŸç»“æœ**:
- âœ… æ‰€æœ‰ä¸‰ä¸ªæ¨¡å¼éƒ½èƒ½æ­£å¸¸åŠ è½½æ¨¡å‹
- âœ… `no_norm` æ¨¡å¼æ‰“å°"å·²åˆ é™¤ 8 ä¸ªå½’ä¸€åŒ–å±‚å‚æ•°"
- âœ… æ²¡æœ‰åŠ è½½é”™è¯¯

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### ä¼˜å…ˆçº§1: å®Œæˆ no_norm æµ‹è¯•

**ç›®çš„**: éªŒè¯æ˜¯å¦å½’ä¸€åŒ–ä¸­æ¯’å¯¼è‡´"é†‰æ±‰èµ°è·¯"

**æµ‹è¯•å‘½ä»¤**:
```bash
python debug_play.py --test no_norm --num_envs 1 --num_episodes 1
```

**åˆ¤æ–­æ ‡å‡†**:
| æŒ‡æ ‡ | å¼€å¯å½’ä¸€åŒ– | å…³é—­å½’ä¸€åŒ–ï¼ˆé¢„æœŸï¼‰| ç»“è®º |
|------|-----------|-----------------|------|
| çº¿é€Ÿåº¦ v | Â±9.0 m/s | **Â±0.5 m/s** | å¦‚æœé™ä½ â†’ **ç¡®è®¤å½’ä¸€åŒ–ä¸­æ¯’** |
| è§’é€Ÿåº¦ w | Â±7.5 rad/s | **Â±2.0 rad/s** | å¦‚æœé™ä½ â†’ **ç¡®è®¤å½’ä¸€åŒ–ä¸­æ¯’** |
| è¡Œä¸ºè¡¨ç° | é†‰æ±‰èµ°è·¯ | **å¯èƒ½æ”¹å–„** | å¦‚æœæ”¹å–„ â†’ éœ€è¦é‡è®­ |

### ä¼˜å…ˆçº§2: å¦‚æœç¡®è®¤å½’ä¸€åŒ–ä¸­æ¯’

**è§£å†³æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**: ä»å¤´è®­ç»ƒ
```bash
# 1. å¤‡ä»½æ—§æ¨¡å‹
mv logs logs_old_$(date +%Y%m%d_%H%M)

# 2. ä»å¤´è®­ç»ƒï¼ˆä½¿ç”¨å½“å‰ä»£ç ï¼‰
python train_v2.py --num_envs 80
```

**è§£å†³æ–¹æ¡ˆBï¼ˆä¸´æ—¶ï¼‰**: æ¸…ç†å½’ä¸€åŒ–ç»Ÿè®¡é‡
```python
# åœ¨åŠ è½½æ¨¡å‹å
policy.actor_obs_normalizer.count = 0
policy.critic_obs_normalizer.count = 0
```
âš ï¸ ä»…ç”¨äºå¿«é€ŸéªŒè¯ï¼Œä¸æ¨èç”¨äºç”Ÿäº§

---

**åˆ›å»ºæ—¶é—´**: 2026-01-26 05:05
**è®°å½•è€…**: Claude Code AI System
**çŠ¶æ€**: âœ… é—®é¢˜å·²è§£å†³
**ä¿®å¤æäº¤**: commit <å¾…æäº¤>
**ä¸‹ä¸€æ­¥**: è¿è¡Œ no_norm æµ‹è¯•ç¡®è®¤å½’ä¸€åŒ–ä¸­æ¯’
