# Play.py 两个严重问题修复记录

> **发现时间**: 2026-01-26 04:25
> **问题来源**: 用户测试 play.py 时发现两个严重bug
> **状态**: ✅ 已修复并记录
> **严重程度**: 🔴 严重（阻塞推理功能）

---

## 问题1: IndexError: too many indices for tensor

### 错误信息

```
IndexError: too many indices for tensor
```

**发生位置**: `play.py` 推理循环中调用 `policy.act_inference()` 时

### 问题分析

**根本原因**: 传入了错误的参数类型

**错误代码**:
```python
# ❌ 错误：传入了 tensor
input_obs = obs_dict['policy']  # 提取出 tensor
actions = policy.act_inference(input_obs)  # 传入 tensor
```

**为什么会这样**：
- RSL-RL 的 `ActorCritic.act_inference()` 期望接收**完整的观测字典**
- ActorCritic 内部会根据 `obs_groups` 配置自动提取需要的部分
- 如果直接传入 tensor，内部尝试用字典键索引时会报 `IndexError`

**正确代码**:
```python
# ✅ 正确：传入完整字典
actions = policy.act_inference(obs_dict)
```

### RSL-RL 内部逻辑

```python
# rsl_rl/modules/actor_critic.py 的 act_inference 方法
def act_inference(self, obs):
    # obs 应该是字典: {"policy": tensor, ...}
    for obs_group in self.obs_groups["policy"]:  # 用键索引
        obs = obs[obs_group]  # 如果 obs 是 tensor 会报 IndexError
    # ...
```

### 解决方案

**实施步骤**:
1. 删除 `input_obs = obs_dict['policy']` 这一行
2. 直接传入 `obs_dict` 给 `act_inference()`

**修复代码**:
```python
# [v6.1 修复] 传入完整观测字典
actions = policy.act_inference(obs_dict)
```

---

## 问题2: 小车嵌在地里（穿模）

### 错误现象

**用户报告**:
- 训练脚本运行正常，机器人位置正确
- 推理脚本（play.py）中机器人陷入地下
- 轮子完全在地下，身体部分也在地下

### 问题分析

**根本原因**: 初始高度（Z轴）设置太低

**当前配置**:
```python
# dashgo_assets.py
init_state=ArticulationCfg.InitialStateCfg(
    pos=(0.0, 0.0, 0.05),  # ❌ 只有5cm
)
```

**为什么会这样**：
- 轮子半径：0.0632m（6.32cm，从 ROS 配置中确认）
- 初始高度：0.05m（5cm）
- **结果**：轮子会陷入地下 1.32cm

**为什么训练时正常**：
- 训练脚本可能有物理预热循环，让机器人落到地面
- 或者训练时使用了不同的随机初始化逻辑
- 推理脚本预热不足或没有重置位置

### 解决方案

**方案1: 增加初始高度（推荐）**

```python
# ✅ 修复后
init_state=ArticulationCfg.InitialStateCfg(
    pos=(0.0, 0.0, 0.15),  # 抬高到15cm
)
```

**计算依据**：
- 轮子半径：6.32cm
- 安全裕度：5cm
- **推荐高度**：6.32 + 5 ≈ 12cm，取15cm更安全

**方案2: 增加物理预热步数**

```python
# play.py 中增加预热
for _ in range(100):  # 增加到100帧
    env.step(torch.zeros(num_envs, 2, device=device))
```

**方案3: 手动设置初始位置**

```python
# 在 env.reset() 之后
root_state = env.scene["robot"].data.default_root_state.clone()
root_state[:, 2] += 0.1  # 抬高10cm
env.scene["robot"].write_root_state_to_sim(root_state)
```

### 排查方法

1. **检查初始高度配置**
   ```bash
   grep -n "init_state" dashgo_assets.py
   grep -n "pos=" dashgo_assets.py
   ```

2. **对比训练脚本**
   - 检查 `train_v2.py` 是否有额外的重置逻辑
   - 检查 `dashgo_env_v2.py` 的 `reset()` 实现

3. **在 GUI 中验证**
   - 暂停仿真
   - 选中机器人，查看 Transform Z 值
   - 选中地面，查看 Transform Z 值
   - 计算：机器人Z 是否 < 地面Z + 轮半径？

4. **检查 USD 文件**
   - 在 Isaac Sim 中打开机器人 USD
   - 验证 base_link 原点位置
   - 验证轮子相对 base_link 的位置

---

## 修复版本历史

### v6.0 (2026-01-26 04:20)
- 开启观测归一化匹配训练 Checkpoint
- 添加 actor_obs_normalization=True
- Commit: 40488af

### v6.1 (2026-01-26 04:25) - ✅ 当前版本
- ❌ 问题1: IndexError - 传入参数类型错误
- ✅ 修复: 传入完整 obs_dict 而非 tensor
- ❌ 问题2: 小车嵌在地里
- ✅ 修复: 初始高度 0.05m → 0.15m
- Commit: a53587a

---

## 关键经验教训

### 1. 理解 RSL-RL 的接口设计
- `act_inference()` 期望字典，不是 tensor
- ActorCritic 内部用 obs_groups 自动提取
- 不要试图"帮助"它提取数据

### 2. Sim2Sim 一致性很重要
- 训练和推理应该使用相同的环境配置
- 初始位置、物理参数、预热逻辑都要一致
- 差异会导致不可预测的行为

### 3. 物理仿真的细节
- 初始高度必须考虑轮子半径
- 留安全裕度（5-10cm）
- 在 GUI 中验证，不要只看代码

### 4. 排查问题的系统方法
1. 从错误信息出发（IndexError → 维度问题）
2. 对比正常和异常情况（训练正常，推理异常）
3. 验证假设（检查代码、查看 GUI）
4. 从根源修复（配置文件），不要打补丁

---

## 验证方法

### 问题1验证
```bash
python play.py --num_envs 1
# 预期：不再报 IndexError，机器人开始运动
```

### 问题2验证
```bash
python play.py --num_envs 1
# 预期：机器人在地面上方，轮子不陷入地下
```

### GUI 检查清单
- [ ] 机器人 Z 坐标 > 0.15m
- [ ] 轮子与地面接触，不穿模
- [ ] 机器人能正常运动
- [ ] 物理行为合理（不穿墙、不漂浮）

---

## 相关文档

- ROS 参数配置: `dashgo/EAI驱动/dashgo_bringup/config/my_dashgo_params.yaml`
- Isaac Lab 资产配置: `dashgo_assets.py`
- 推理脚本: `play.py`
- 训练脚本: `train_v2.py`

---

**创建时间**: 2026-01-26 04:30
**记录者**: Claude Code AI System
**状态**: ✅ 问题已解决并文档化
**最终版本**: v6.1 (commit a53587a)
**下一步**: 用户测试修复后的 play.py
