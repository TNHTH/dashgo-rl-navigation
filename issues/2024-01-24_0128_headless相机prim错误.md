# é—®é¢˜è®°å½•ï¼šheadless æ¨¡å¼ä¸‹ç›¸æœºä¼ æ„Ÿå™¨ prim è·¯å¾„é”™è¯¯

> **å‘ç°æ—¶é—´**: 2026-01-24 01:28:00
> **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ä¸¥é‡
> **çŠ¶æ€**: âœ… å·²è§£å†³
> **ç›¸å…³æ–‡ä»¶**: `dashgo_env_v2.py`, `run_headless_train.sh`

---

## é—®é¢˜æè¿°

ä½¿ç”¨ `--headless` å‚æ•°è®­ç»ƒæ—¶å‡ºç°è¿è¡Œæ—¶é”™è¯¯ï¼š

```bash
~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80
```

**é”™è¯¯ä¿¡æ¯**ï¼š
```
RuntimeError: Could not find prim with path /World/envs/env_.*/Dashgo/base_link/lidar_cam.
```

**æ¬¡è¦é—®é¢˜**ï¼šå³ä½¿åŠ äº† `--headless`ï¼ŒIsaac Sim è¿˜æ˜¯æ‰“å¼€äº† GUI çª—å£ã€‚

---

## æ ¹æœ¬åŸå› 

### 1. ç›´æ¥åŸå› 

**é”™è¯¯çš„è§£å†³æ–¹æ¡ˆ**ï¼ˆä¹‹å‰çš„å°è¯•ï¼‰ï¼š
```python
# âŒ é”™è¯¯åšæ³•ï¼šè®¾ç½® spawn=None
if is_headless_mode():
    lidar_sensor = CameraCfg(..., spawn=None)
```

**ä¸ºä»€ä¹ˆå¤±è´¥**ï¼š
- `spawn=None` **ä¸ä¼šè·³è¿‡ç›¸æœºåˆ›å»º**
- Isaac Lab ä»ç„¶ä¼šå°è¯•è®¿é—® `prim_path`
- å¯¼è‡´ `RuntimeError: Could not find prim`

### 2. æ·±å±‚åŸå› 

**Isaac Lab çš„è®¾è®¡é€»è¾‘**ï¼š
1. **é…ç½®å®šä¹‰é˜¶æ®µ**ï¼šæ‰€æœ‰ä¼ æ„Ÿå™¨å¿…é¡»åœ¨é…ç½®ä¸­å®šä¹‰
2. **åœºæ™¯åˆ›å»ºé˜¶æ®µ**ï¼šæ ¹æ®é…ç½®åˆ›å»ºä¼ æ„Ÿå™¨ï¼ˆåŒ…æ‹¬ prim è®¿é—®ï¼‰
3. **`spawn=None` çš„å«ä¹‰**ï¼šä¸åˆ›å»ºç›¸æœº**å¯¹è±¡**ï¼Œä½†ä»è¦è®¿é—® prim

**æ­£ç¡®åšæ³•**ï¼š
- headless æ¨¡å¼ä¸‹**å®Œå…¨ä¸è¦å®šä¹‰** `lidar_sensor`
- ä½¿ç”¨æ¡ä»¶è¯­å¥æ’é™¤æ•´ä¸ªä¼ æ„Ÿå™¨å®šä¹‰

### 3. GUI çª—å£é—®é¢˜

**Isaac Sim çš„å·²çŸ¥è¡Œä¸º**ï¼š
- å³ä½¿åŠ äº† `--headless`ï¼Œåªè¦æ£€æµ‹åˆ° `DISPLAY` ç¯å¢ƒå˜é‡ï¼Œå°±ä¼šå¯åŠ¨ GUI
- è¿™æ˜¯ Isaac Sim çš„æ¶æ„ç‰¹æ€§ï¼ˆåº•å±‚ä¾èµ–å›¾å½¢ç³»ç»Ÿï¼‰

**å®é™…å½±å“**ï¼š
- âš ï¸ çª—å£ä¼šæ‰“å¼€ï¼Œä½†**ä¸å½±å“è®­ç»ƒ**
- âœ… è®­ç»ƒä»ç„¶åœ¨ GPU ä¸Šè¿è¡Œ
- ğŸ’¡ å¯ä»¥æœ€å°åŒ–çª—å£ï¼Œä¸å½±å“æ€§èƒ½

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ¡ä»¶æ’é™¤ä¼ æ„Ÿå™¨å®šä¹‰ï¼ˆå·²é‡‡ç”¨ï¼‰âœ…

**æ ¸å¿ƒæ€æƒ³**ï¼šheadless æ¨¡å¼ä¸‹å®Œå…¨ä¸è¦å®šä¹‰ä¼ æ„Ÿå™¨ã€‚

```python
# âœ… æ­£ç¡®åšæ³•ï¼šæ¡ä»¶æ’é™¤
if not is_headless_mode():
    lidar_sensor = CameraCfg(
        prim_path="{ENV_REGEX_NS}/Dashgo/base_link/lidar_cam",
        spawn=sim_utils.PinholeCameraCfg(...),
        ...
    )
# headless æ¨¡å¼ä¸‹ lidar_sensor æœªå®šä¹‰
```

**çº§è”ä¿®æ”¹**ï¼šè§‚æµ‹å’Œå¥–åŠ±é…ç½®ä¹Ÿéœ€è¦æ¡ä»¶åˆ¤æ–­ã€‚

**è§‚æµ‹é…ç½®**ï¼š
```python
class PolicyCfg(ObservationGroupCfg):
    if not is_headless_mode():
        lidar = ObservationTermCfg(
            func=process_lidar_ranges,
            params={"sensor_cfg": SceneEntityCfg("lidar_sensor")}
        )
```

**å¥–åŠ±é…ç½®**ï¼š
```python
class DashgoRewardsCfg:
    if is_headless_mode():
        # ä¸ä½¿ç”¨ä¼ æ„Ÿå™¨
        velodyne_style_reward = RewardTermCfg(
            func=lambda env, asset_cfg, command_name: reward_navigation_sota(env, asset_cfg, None, command_name),
            ...
        )
    else:
        # ä½¿ç”¨ä¼ æ„Ÿå™¨
        velodyne_style_reward = RewardTermCfg(
            func=reward_navigation_sota,
            params={"sensor_cfg": SceneEntityCfg("lidar_sensor")},
            ...
        )
```

**å¥–åŠ±å‡½æ•°**ï¼š
```python
def reward_navigation_sota(env, asset_cfg, sensor_cfg, command_name):
    # ...
    if sensor_cfg is not None:
        depth_radial = _get_corrected_depth(env, sensor_cfg)
        # é¿éšœæƒ©ç½š...
    else:
        # headless æ¨¡å¼ï¼šè·³è¿‡é¿éšœæƒ©ç½š
        reward_collision = torch.zeros(forward_vel.shape, device=env.device)
```

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨è™šæ‹Ÿå¸§ç¼“å†²ï¼ˆå¯é€‰ï¼‰

å¦‚æœç¡®å®éœ€è¦å®Œå…¨ headlessï¼ˆä¸æ‰“å¼€çª—å£ï¼‰ï¼Œä½¿ç”¨ `xvfb`ï¼š

```bash
# å®‰è£… xvfb
sudo apt-get install xvfb

# ä½¿ç”¨ xvfb-run å¯åŠ¨è®­ç»ƒ
xvfb-run -a ~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80
```

**æ³¨æ„**ï¼š
- `xvfb` åˆ›å»ºè™šæ‹Ÿæ˜¾ç¤ºï¼ŒIsaac Sim ä¸ä¼šæ‰“å¼€çª—å£
- `-a` å‚æ•°è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„ display ç¼–å·

### æ–¹æ¡ˆ3ï¼šä¸“ç”¨å¯åŠ¨è„šæœ¬ï¼ˆå·²åˆ›å»ºï¼‰âœ…

åˆ›å»ºäº† `run_headless_train.sh`ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
#!/bin/bash
# è®¾ç½® Isaac Sim ä¸ºçº¯ headless æ¨¡å¼
export IsaacLAB_WINDOWED=0

# å¯åŠ¨è®­ç»ƒ
~/IsaacLab/isaaclab.sh -p train_v2.py --headless "$@"
```

**æ³¨æ„**ï¼š
- è¿™åªæ˜¯è¾…åŠ©è„šæœ¬ï¼Œä»ç„¶å¯èƒ½æ‰“å¼€çª—å£ï¼ˆIsaac Sim çš„ç‰¹æ€§ï¼‰
- çª—å£æ‰“å¼€ä¸å½±å“è®­ç»ƒ

---

## å®æ–½æ­¥éª¤

1. **ä¿®æ”¹ä¼ æ„Ÿå™¨å®šä¹‰**
   ```python
   # dashgo_env_v2.py
   if not is_headless_mode():
       lidar_sensor = CameraCfg(...)
   ```

2. **ä¿®æ”¹è§‚æµ‹é…ç½®**
   ```python
   class PolicyCfg(ObservationGroupCfg):
       if not is_headless_mode():
           lidar = ObservationTermCfg(...)
   ```

3. **ä¿®æ”¹å¥–åŠ±é…ç½®**
   ```python
   class DashgoRewardsCfg:
       if is_headless_mode():
           # ä¸ä½¿ç”¨ä¼ æ„Ÿå™¨
       else:
           # ä½¿ç”¨ä¼ æ„Ÿå™¨
   ```

4. **ä¿®æ”¹å¥–åŠ±å‡½æ•°**
   ```python
   if sensor_cfg is not None:
       # é¿éšœæƒ©ç½š
   else:
       # è·³è¿‡é¿éšœæƒ©ç½š
   ```

5. **æäº¤ä¿®æ”¹**
   ```bash
   git add dashgo_env_v2.py run_headless_train.sh
   git commit -m "fix: ä¿®å¤headlessæ¨¡å¼ç›¸æœºä¼ æ„Ÿå™¨"
   ```

6. **éªŒè¯è®­ç»ƒ**
   ```bash
   # æ–¹æ³•1: ç›´æ¥ä½¿ç”¨ï¼ˆä¼šæ‰“å¼€çª—å£ï¼‰
   ~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80

   # æ–¹æ³•2: ä½¿ç”¨ä¸“ç”¨è„šæœ¬
   ./run_headless_train.sh --num_envs 80

   # æ–¹æ³•3: å®Œå…¨ headlessï¼ˆéœ€è¦ xvfbï¼‰
   xvfb-run -a ~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80
   ```

---

## éªŒè¯æ–¹æ³•

### è‡ªåŠ¨éªŒè¯
è¿è¡Œè®­ç»ƒå‘½ä»¤ï¼Œåº”è¯¥æˆåŠŸå¯åŠ¨ï¼š
```bash
~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80
```

**é¢„æœŸè¾“å‡º**ï¼š
```
[INFO] åˆå§‹åŒ–è®­ç»ƒæµç¨‹...
Setting seed: 42
[INFO]: Base environment:
    Environment device    : cuda:0
...
[INFO] å¼€å§‹è®­ç»ƒ: dashgo_nav
```

### æ‰‹åŠ¨éªŒè¯
æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åœ¨ GPU ä¸Šè¿è¡Œï¼š
```bash
nvidia-smi
```

åº”è¯¥çœ‹åˆ° GPU åˆ©ç”¨ç‡ > 50%

---

## ç»éªŒæ•™è®­

### 1. spawn=None çš„å«ä¹‰
- âŒ é”™è¯¯ç†è§£ï¼š`spawn=None` è·³è¿‡ä¼ æ„Ÿå™¨åˆ›å»º
- âœ… æ­£ç¡®ç†è§£ï¼š`spawn=None` ä¸åˆ›å»ºç›¸æœº**å¯¹è±¡**ï¼Œä½†ä»è®¿é—® prim
- **ç»“è®º**ï¼šè¦å®Œå…¨æ’é™¤ä¼ æ„Ÿå™¨ï¼Œéœ€è¦åœ¨é…ç½®é˜¶æ®µå°±ä¸å®šä¹‰å®ƒ

### 2. æ¡ä»¶é…ç½®çš„æ­£ç¡®åšæ³•
- âŒ é”™è¯¯ï¼šåœ¨ä¼ æ„Ÿå™¨å®šä¹‰ä¸­ä½¿ç”¨ `spawn=None`
- âœ… æ­£ç¡®ï¼šåœ¨é…ç½®ç±»ä¸­ä½¿ç”¨æ¡ä»¶è¯­å¥æ’é™¤æ•´ä¸ªä¼ æ„Ÿå™¨å®šä¹‰
- **æ–¹æ³•**ï¼š`if not is_headless_mode(): lidar_sensor = ...`

### 3. Isaac Sim çš„ headless é™åˆ¶
- `--headless` å‚æ•°**ä¸ä¼šé˜»æ­¢çª—å£æ‰“å¼€**
- åªè¦æ£€æµ‹åˆ° `DISPLAY`ï¼Œå°±ä¼šå¯åŠ¨ GUI
- **å®é™…å½±å“**ï¼šçª—å£æ‰“å¼€ä½†ä¸å½±å“è®­ç»ƒ
- **å®Œå…¨ headless**ï¼šéœ€è¦ä½¿ç”¨ `xvfb` è™šæ‹Ÿå¸§ç¼“å†²

### 4. çº§è”ä¿®æ”¹çš„å¿…è¦æ€§
- ä¿®æ”¹ä¼ æ„Ÿå™¨å®šä¹‰ â†’ å¿…é¡»ä¿®æ”¹è§‚æµ‹é…ç½®
- ä¿®æ”¹è§‚æµ‹é…ç½® â†’ å¯èƒ½éœ€è¦ä¿®æ”¹å¥–åŠ±é…ç½®
- ä¿®æ”¹å¥–åŠ±é…ç½® â†’ å¯èƒ½éœ€è¦ä¿®æ”¹å¥–åŠ±å‡½æ•°
- **åŸåˆ™**ï¼šè¿½è¸ªæ‰€æœ‰å¼•ç”¨ï¼Œç¡®ä¿ä¸€è‡´æ€§

---

## åç»­ä¼˜åŒ–

### å¯é€‰æ”¹è¿›1ï¼šä½¿ç”¨ RayCaster ä¼ æ„Ÿå™¨

RayCaster ä¼ æ„Ÿå™¨ä¸ä¾èµ–æ¸²æŸ“ï¼Œå¯ä»¥åœ¨ headless æ¨¡å¼æ­£å¸¸ä½¿ç”¨ï¼š

```python
from isaaclab.sensors import RayCasterCfg

lidar_sensor = RayCasterCfg(
    prim_path="{ENV_REGEX_NS}/Dashgo/base_link/lidar",
    update_period=0.0664,
    rays_spawn=RayCasterCfg.SpawnCfg(
        pattern="grid",
        size=(1, 180),
        ...
    )
)
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¾èµ–æ¸²æŸ“
- âœ… å¯ä»¥åœ¨ headless æ¨¡å¼ä½¿ç”¨
- âœ… æ›´çœŸå®çš„æ¿€å…‰é›·è¾¾æ¨¡æ‹Ÿ

### å¯é€‰æ”¹è¿›2ï¼šåˆ†ç¦»è§‚æµ‹ç©ºé—´é…ç½®

åˆ›å»ºä¸¤å¥—é…ç½®ï¼š
- `PolicyCfgWithLidar`ï¼šåŒ…å«æ¿€å…‰é›·è¾¾ï¼ˆGUI æ¨¡å¼ï¼‰
- `PolicyCfgWithoutLidar`ï¼šä¸åŒ…å«æ¿€å…‰é›·è¾¾ï¼ˆheadless æ¨¡å¼ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ¸…æ™°åˆ†ç¦»ä¸¤ç§æ¨¡å¼
- âœ… é¿å…è¿è¡Œæ—¶æ¡ä»¶åˆ¤æ–­
- **ç¼ºç‚¹**ï¼šç»´æŠ¤ä¸¤å¥—é…ç½®

### å¯é€‰æ”¹è¿›3ï¼šè‡ªåŠ¨æ¨¡å¼æ£€æµ‹

ä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®š `--headless`ï¼Œæ ¹æ®æ˜¯å¦æœ‰æ˜¾ç¤ºå™¨è‡ªåŠ¨é€‰æ‹©ï¼š

```python
import os

def has_display():
    return os.environ.get('DISPLAY') is not None

if not has_display():
    # è‡ªåŠ¨ä½¿ç”¨ headless é…ç½®
    lidar_sensor = None
else:
    lidar_sensor = CameraCfg(...)
```

---

## ç›¸å…³æäº¤

- **commit**: `7a799af` - fix: ä¿®å¤headlessæ¨¡å¼ç›¸æœºä¼ æ„Ÿå™¨å’Œæä¾›ä¸“ç”¨å¯åŠ¨è„šæœ¬
- **æ–‡ä»¶**: `dashgo_env_v2.py` (62 insertions, 29 deletions)
- **æ–‡ä»¶**: `run_headless_train.sh` (æ–°å»º)

---

## ç›¸å…³æ–‡æ¡£

- **Isaac Lab æ–‡æ¡£**: https://isaac-sim.github.io/IsaacLab/main/reference/api/isaaclab/sensors.html
- **ç›¸æœºä¼ æ„Ÿå™¨**: CameraCfg é…ç½®è¯´æ˜
- **RayCaster ä¼ æ„Ÿå™¨**: æ›¿ä»£æ–¹æ¡ˆï¼ˆä¸ä¾èµ–æ¸²æŸ“ï¼‰
- **xvfb è™šæ‹Ÿå¸§ç¼“å†²**: å®Œå…¨ headless çš„è§£å†³æ–¹æ¡ˆ

---

**é—®é¢˜çŠ¶æ€**: âœ… å·²è§£å†³
**è§£å†³æ—¶é—´**: 2026-01-24 01:35
**éªŒè¯æ–¹å¼**: âœ… headless æ¨¡å¼å¯ä»¥æ­£å¸¸å¯åŠ¨è®­ç»ƒ
**æ³¨æ„äº‹é¡¹**:
- çª—å£å¯èƒ½ä»ç„¶æ‰“å¼€ï¼ˆIsaac Sim çš„ç‰¹æ€§ï¼‰
- çª—å£æ‰“å¼€ä¸å½±å“è®­ç»ƒ
- headless æ¨¡å¼ä¸‹æ¿€å…‰é›·è¾¾è§‚æµ‹è¢«ç¦ç”¨
- å»ºè®®ï¼šä½¿ç”¨ RayCaster ä¼ æ„Ÿå™¨æ›¿ä»£ç›¸æœºä¼ æ„Ÿå™¨
