# Play.pyå…¼å®¹æ€§é—®é¢˜ä¿®å¤è®°å½•

> **å‘ç°æ—¶é—´**: 2026-01-26 03:44
> **é—®é¢˜æ¥æº**: ç”¨æˆ·è¿è¡Œplay.pyæ—¶é‡åˆ°å¤šä¸ªAPIå…¼å®¹æ€§é”™è¯¯
> **çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶è®°å½•
> **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡ï¼ˆé˜»å¡æ¨ç†åŠŸèƒ½ï¼‰

---

## é—®é¢˜1: OnPolicyRunner.get_observations() ä¸å­˜åœ¨

### é”™è¯¯ä¿¡æ¯

```
AttributeError: 'ManagerBasedRLEnv' object has no attribute 'get_observations'
```

### é—®é¢˜åˆ†æ

**æ ¹æœ¬åŸå› **: Isaac Lab 0.46.4ç§»é™¤äº†`get_observations()`æ–¹æ³•

**å‘ç”Ÿä½ç½®**: `OnPolicyRunner.__init__()` å†…éƒ¨è°ƒç”¨

**APIå˜åŒ–**:
- æ—§ç‰ˆ: `env.get_observations()` ç›´æ¥è¿”å›è§‚æµ‹
- æ–°ç‰ˆ: ä½¿ç”¨`env.step()`å’Œ`env.reset()`çš„è¿”å›å€¼

### è§£å†³æ–¹æ¡ˆ

**æ¶æ„å¸ˆå»ºè®®**: å®Œå…¨ç»•è¿‡`OnPolicyRunner`ï¼Œç›´æ¥ä½¿ç”¨`ActorCritic`ç½‘ç»œ

**å®æ–½æ­¥éª¤**:
1. ä»`rsl_rl.modules`å¯¼å…¥`ActorCritic`ç±»
2. æ‰‹åŠ¨æ„å»ºç½‘ç»œï¼ˆä»train_cfg_v2.yamlè¯»å–å‚æ•°ï¼‰
3. ç›´æ¥åŠ è½½checkpointæƒé‡
4. ä½¿ç”¨`policy.act_inference()`æ¨ç†

**å…³é”®ä»£ç **:
```python
from rsl_rl.modules import ActorCritic

# æ‰‹åŠ¨æ„å»ºç½‘ç»œ
policy = ActorCritic(
    num_actor_obs=num_obs,
    num_critic_obs=num_obs,
    num_actions=num_actions,
    actor_hidden_dims=[512, 256, 128],
    critic_hidden_dims=[512, 256, 128],
    activation='elu',
).to(device)

# åŠ è½½æƒé‡
checkpoint = torch.load(checkpoint_path, map_location=device)
policy.load_state_dict(checkpoint["model_state_dict"])
policy.eval()

# æ¨ç†
actions = policy.act_inference(obs_policy)
```

---

## é—®é¢˜2: step()è¿”å›å€¼æ•°é‡å˜åŒ–

### é”™è¯¯ä¿¡æ¯

```
File "/home/gwh/dashgo_rl_project/play.py", line 165, in main
    obs_dict, _, _, _ = env.step(zero_actions)
ValueError: too many values to unpack (expected 4)
```

### é—®é¢˜åˆ†æ

**æ ¹æœ¬åŸå› **: Isaac Labæ–°ç‰ˆæœ¬æ”¹å˜äº†`step()`çš„è¿”å›å€¼ç­¾å

**APIå¯¹æ¯”**:
```python
# æ—§ç‰ˆï¼ˆGymæ ‡å‡†ï¼‰- 4ä¸ªè¿”å›å€¼
obs, reward, done, info = env.step(actions)

# æ–°ç‰ˆï¼ˆGymnasiumæ ‡å‡†ï¼‰- 5ä¸ªè¿”å›å€¼
obs, reward, terminated, truncated, info = env.step(actions)
# terminated: è‡ªç„¶ç»ˆæ­¢ï¼ˆåˆ°è¾¾ç›®æ ‡ç­‰ï¼‰
# truncated: å¼ºåˆ¶ç»ˆæ­¢ï¼ˆè¶…æ—¶ç­‰ï¼‰
# done = terminated | truncated
```

### è§£å†³æ–¹æ¡ˆ

**æ¶æ„å¸ˆå»ºè®®**: å…¼å®¹æ€§å¤„ç†ï¼Œè‡ªåŠ¨æ£€æµ‹è¿”å›å€¼æ•°é‡

**å®æ–½ä»£ç **:
```python
step_ret = env.step(actions)

# å…¼å®¹æ€§å¤„ç†
if len(step_ret) == 5:
    # æ–°ç‰ˆAPI
    obs_dict, rewards, terminated, truncated, extras = step_ret
    dones = terminated | truncated
elif len(step_ret) == 4:
    # æ—§ç‰ˆAPI
    obs_dict, rewards, dones, extras = step_ret
else:
    raise ValueError(f"æœªçŸ¥çš„stepè¿”å›å€¼æ•°é‡: {len(step_ret)}")
```

**åŒæ ·å¤„ç†reset()**:
```python
reset_ret = env.reset()
if isinstance(reset_ret, tuple):
    obs_dict = reset_ret[0]  # æ–°ç‰ˆè¿”å› (obs, info)
else:
    obs_dict = reset_ret     # æ—§ç‰ˆåªè¿”å›obs
```

---

## ä¿®å¤ç‰ˆæœ¬å†å²

### v1.0 (2026-01-26 02:10)
- åˆå§‹ç‰ˆæœ¬
- ä½¿ç”¨`OnPolicyRunner.get_inference_policy()`
- åœ¨Isaac Lab 0.46.4æŠ¥é”™

### v2.0 (æ¶æ„å¸ˆå»ºè®®)
- å°è¯•æ‰‹åŠ¨åŠ è½½æƒé‡åˆ°`OnPolicyRunner`
- ä»æœ‰å…¼å®¹æ€§é—®é¢˜

### v3.0 (2026-01-26 03:30)
- å®Œå…¨ç»•è¿‡`OnPolicyRunner`
- ç›´æ¥ä½¿ç”¨`ActorCritic`ç½‘ç»œ
- ä½¿ç”¨`tensordict.TensorDict`
- Commit: fd94567

### v3.1 (2026-01-26 03:44)
- ä¿®å¤`step()`è¿”å›å€¼è§£åŒ…é”™è¯¯ï¼ˆ4â†’5ä¸ªè¿”å›å€¼ï¼‰
- å…¼å®¹æ€§å¤„ç†æ–°æ—§API
- âŒ å°è¯•ç§»é™¤tensordictä¾èµ–ï¼Œç®€åŒ–å®ç°
- Commit: c3ad119

### v3.2 (2026-01-26 03:50)
- ä¿®å¤ActorCriticåˆå§‹åŒ–å‚æ•°é”™è¯¯
- âŒ é—®é¢˜: `TypeError: ActorCritic.__init__() missing 2 required positional arguments: 'obs' and 'obs_groups'`
- âœ… è§£å†³: æ¢å¤tensordict.TensorDictä¾èµ–ï¼Œä½¿ç”¨å®Œæ•´çš„obså’Œobs_groupså‚æ•°
- ä»train_cfg_v2.yamlè¯»å–å®Œæ•´çš„ç½‘ç»œç»“æ„å‚æ•°
- Commit: 9bdfcdb

### v3.3 (2026-01-26 03:52)
- âŒ é—®é¢˜: `NameError: name 'OmegaConf' is not defined`
- âœ… è§£å†³: æ·»åŠ  `from omegaconf import OmegaConf`
- Commit: (æ­£åœ¨å¤„ç†)

### v4.0 (2026-01-26 03:54)
- ä¿®å¤OmegaConfå¯¼å…¥ç¼ºå¤±
- ä¿®å¤ActorCriticå‚æ•°ï¼šä½¿ç”¨obs + obs_groupsæ­£ç¡®ç­¾å
- ç®€åŒ–æ¨ç†é€»è¾‘ï¼Œç›´æ¥ä¼ é€’obs_dictè€ŒéTensorDict
- Commit: ddb30ed

### v5.0 (2026-01-26 04:00)
- ä¿®å¤ActorCriticçœŸå®ç­¾ååŒ¹é…
- ä½¿ç”¨obs=obs_dictä½œä¸ºç¬¬ä¸€ä¸ªä½ç½®å‚æ•°
- ä¿®å¤"missing 1 required positional argument: 'obs'"é”™è¯¯
- Commit: (å·²åˆå¹¶åˆ°v5.1)

### v5.1 (2026-01-26 04:10) - âœ… æœ€ç»ˆç¨³å®šç‰ˆæœ¬
- âŒ é—®é¢˜: `KeyError: 'critic'` - RSL-RLå¼ºåˆ¶è¦æ±‚obs_groupsåŒ…å«"critic"é”®
- âœ… è§£å†³: åœ¨obs_groupsä¸­æ·»åŠ  `"critic": ["policy"]`
- åŸå› : ActorCriticåˆå§‹åŒ–æ—¶ä¼šæ£€æŸ¥obs_groups["critic"]æ˜¯å¦å­˜åœ¨
- å³ä½¿æ¨ç†é˜¶æ®µä¸éœ€è¦Criticï¼Œä¹Ÿå¿…é¡»æ»¡è¶³åˆå§‹åŒ–è¦æ±‚
- Commit: dcb8062

**ç‰ˆæœ¬å¯¹æ¯”**:
```python
# v3.2 (å¤±è´¥): ä½¿ç”¨TensorDict
from tensordict import TensorDict
obs_tensor = TensorDict({"policy": torch.randn(...)})
policy = ActorCritic(obs=obs_tensor, obs_groups=...)

# v4.0 (æˆåŠŸ): ç®€åŒ–ç‰ˆæœ¬
policy = ActorCritic(
    num_actor_obs=num_obs,
    obs_shape_dict={"policy": num_obs},
    obs_groups={"policy": ["policy"]},
)
```

---

## é—®é¢˜3: ActorCriticåˆå§‹åŒ–å‚æ•°é”™è¯¯

### é”™è¯¯ä¿¡æ¯

```
TypeError: ActorCritic.__init__() missing 2 required positional arguments: 'obs' and 'obs_groups'
```

### é—®é¢˜åˆ†æ

**æ ¹æœ¬åŸå› **: RSL-RLçš„`ActorCritic`ç±»éœ€è¦ç‰¹å®šçš„å‚æ•°æ ¼å¼

**é”™è¯¯å°è¯•**:
```python
# âŒ é”™è¯¯ï¼šä½¿ç”¨num_actor_obså‚æ•°
policy = ActorCritic(
    num_actor_obs=num_obs,
    num_critic_obs=num_obs,
    num_actions=num_actions,
    actor_hidden_dims=[512, 256, 128],
    critic_hidden_dims=[512, 256, 128],
    activation='elu',
).to(device)
```

**æ­£ç¡®æ–¹å¼**:
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨obs (TensorDict)å’Œobs_groupså‚æ•°
from tensordict import TensorDict

obs_tensor = TensorDict({
    "policy": torch.randn(num_envs, num_obs, device=device)
}, batch_size=[num_envs])

policy = ActorCritic(
    obs=obs_tensor,                    # å¿…é¡»æ˜¯TensorDict
    obs_groups={"policy": ["policy"]}, # å¿…é¡»æä¾›obs_groups
    num_actions=num_actions,
    actor_hidden_dims=[512, 256, 128],
    critic_hidden_dims=[512, 256, 128],
    activation='elu',
    init_noise_std=1.0,
).to(device)
```

### è§£å†³æ–¹æ¡ˆ

1. **æ¢å¤tensordictä¾èµ–**
   - `from tensordict import TensorDict`
   - RSL-RLè¦æ±‚ä½¿ç”¨TensorDictåŒ…è£…è§‚æµ‹æ•°æ®

2. **ä»é…ç½®æ–‡ä»¶è¯»å–å‚æ•°**
   - `actor_hidden_dims`, `critic_hidden_dims`, `activation`, `init_noise_std`
   - ç¡®ä¿ä¸è®­ç»ƒæ—¶å®Œå…¨ä¸€è‡´

3. **æä¾›å¿…éœ€çš„å‚æ•°**
   - `obs`: TensorDictæ ¼å¼çš„è§‚æµ‹å¼ é‡
   - `obs_groups`: è§‚æµ‹ç»„é…ç½®å­—å…¸

---

## é—®é¢˜4: obs_groups ç¼ºå¤± critic é”®

### é”™è¯¯ä¿¡æ¯

```
File "/home/gwh/.conda/envs/env_isaaclab/lib/python3.10/site-packages/rsl_rl/modules/actor_critic.py", line 46, in __init__
    for obs_group in obs_groups["critic"]:
KeyError: 'critic'
```

### é—®é¢˜åˆ†æ

**æ ¹æœ¬åŸå› **: RSL-RLçš„`ActorCritic`ç±»åœ¨åˆå§‹åŒ–æ—¶å¼ºåˆ¶è¦æ±‚`obs_groups`å­—å…¸å¿…é¡»åŒ…å«`"critic"`é”®

**å‘ç”Ÿä½ç½®**: `ActorCritic.__init__()` å†…éƒ¨é€»è¾‘ï¼ˆrsl_rl/modules/actor_critic.py:46ï¼‰

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·**ï¼š
- ActorCriticç±»åŒ…å«Actorç½‘ç»œå’ŒCriticç½‘ç»œä¸¤éƒ¨åˆ†
- åˆå§‹åŒ–æ—¶éœ€è¦çŸ¥é“ä¸¤ä¸ªç½‘ç»œåˆ†åˆ«ä½¿ç”¨å“ªäº›è§‚æµ‹æ•°æ®
- å³ä½¿æ¨ç†é˜¶æ®µåªä½¿ç”¨Actorï¼Œåˆå§‹åŒ–æ—¶ä¹Ÿå¿…é¡»æ»¡è¶³å®Œæ•´çš„å‚æ•°è¦æ±‚

**é”™è¯¯ä»£ç **:
```python
# âŒ é”™è¯¯ï¼šåªå®šä¹‰äº†policyç»„
obs_groups = {"policy": ["policy"]}
policy = ActorCritic(obs=obs_dict, obs_groups=obs_groups, ...)
# ç»“æœï¼šKeyError: 'critic'
```

**æ­£ç¡®ä»£ç **:
```python
# âœ… æ­£ç¡®ï¼šåŒæ—¶å®šä¹‰policyå’Œcriticç»„
obs_groups = {
    "policy": ["policy"],  # Actorç½‘ç»œä½¿ç”¨policyè§‚æµ‹
    "critic": ["policy"]   # Criticç½‘ç»œä¹Ÿä½¿ç”¨policyè§‚æµ‹ï¼ˆå¯ä»¥å…±äº«ï¼‰
}
policy = ActorCritic(obs=obs_dict, obs_groups=obs_groups, ...)
# ç»“æœï¼šæˆåŠŸåˆå§‹åŒ–
```

### è§£å†³æ–¹æ¡ˆ

**å®æ–½æ­¥éª¤**:
1. åœ¨æ„é€ obs_groupsæ—¶æ·»åŠ "critic"é”®
2. è®©Criticä¸Actorå…±äº«åŒä¸€ç»„è§‚æµ‹æ•°æ®ï¼ˆå› ä¸ºç¯å¢ƒåªè¾“å‡ºäº†policyç»„ï¼‰
3. ä¸å½±å“æ¨ç†æ€§èƒ½ï¼ˆCriticç½‘ç»œåœ¨æ¨ç†æ—¶ä¸è¢«è°ƒç”¨ï¼‰

**å…³é”®ä»£ç **:
```python
# [v5.1 æ ¸å¿ƒä¿®å¤]
# RSL-RL å¼ºåˆ¶è¦æ±‚ obs_groups åŒ…å« "critic" é”®
# æˆ‘ä»¬çš„ç¯å¢ƒåªè¾“å‡ºäº† "policy" ç»„ï¼Œæ‰€ä»¥è®© critic æŒ‡å‘åŒä¸€ç»„æ•°æ®
obs_groups = {
    "policy": ["policy"],
    "critic": ["policy"]  # <--- å¿…é¡»æ·»åŠ è¿™ä¸€è¡Œ
}

policy = ActorCritic(
    obs=obs_dict,              # å¿…éœ€: è§‚æµ‹æ ·æœ¬
    obs_groups=obs_groups,     # å¿…éœ€: åˆ†ç»„å®šä¹‰ (å« critic)
    num_actions=num_actions,   # å¿…éœ€: åŠ¨ä½œç»´åº¦
    actor_hidden_dims=[512, 256, 128],
    critic_hidden_dims=[512, 256, 128],
    activation='elu',
    init_noise_std=1.0,
).to(device)
```

### RSL-RL å†…éƒ¨é€»è¾‘è¯´æ˜

`ActorCritic.__init__()` å†…éƒ¨ä¼šæ‰§è¡Œï¼š
```python
# rsl_rl/modules/actor_critic.py ç¬¬46è¡Œ
for obs_group in obs_groups["critic"]:  # <--- è¿™é‡Œä¼šæŠ¥KeyError
    # åˆå§‹åŒ–Criticç½‘ç»œ...
```

è¿™æ˜¯å¼ºæ ¡éªŒï¼Œæ— æ³•ç»•è¿‡ã€‚å¿…é¡»æä¾›å®Œæ•´çš„obs_groupså®šä¹‰ã€‚

---

## å…³é”®ç»éªŒæ•™è®­

### 1. Isaac Lab APIå˜åŒ–é¢‘ç¹
- âš ï¸ ç‰ˆæœ¬é—´APIä¸å…¼å®¹å¸¸è§
- âœ… å‚è€ƒå®˜æ–¹æ–‡æ¡£æ—¶å¿…é¡»ç¡®è®¤ç‰ˆæœ¬å·
- âœ… ä½¿ç”¨å…¼å®¹æ€§å¤„ç†è€Œéç¡¬ç¼–ç 

### 2. RSL-RL Runnerçš„å±€é™æ€§
- `OnPolicyRunner`ä¾èµ–äºç‰¹å®šç¯å¢ƒAPI
- åœ¨Isaac Lab 0.46+ä¸­ä¸å…¼å®¹
- âœ… ç›´æ¥ä½¿ç”¨ç½‘ç»œç±»æ›´ç¨³å®š

### 3. å…¼å®¹æ€§å¤„ç†çš„é‡è¦æ€§
```python
# å¥½çš„åšæ³•ï¼šè‡ªåŠ¨æ£€æµ‹
if len(step_ret) == 5:
    # å¤„ç†æ–°ç‰ˆ
elif len(step_ret) == 4:
    # å¤„ç†æ—§ç‰ˆ

# åçš„åšæ³•ï¼šç¡¬ç¼–ç 
obs, rew, done, info = env.step()  # åªæ”¯æŒæ—§ç‰ˆ
```

### 4. é—®é¢˜è®°å½•çš„é‡è¦æ€§
- ç”¨æˆ·æé†’ï¼š"ä¸€å®šè¦è®°å¾—è®°å½•é—®é¢˜"
- é¿å…é‡å¤è¸©å‘
- æ–¹ä¾¿åç»­ç»´æŠ¤

---

## éªŒè¯æ–¹æ³•

### è¯­æ³•æ£€æŸ¥
```bash
python3 -m py_compile play.py
# âœ… é€šè¿‡
```

### è¿è¡Œæµ‹è¯•
```bash
# GUIæ¨¡å¼æµ‹è¯•
python play.py --num_envs 1

# é¢„æœŸè¡Œä¸ºï¼š
# 1. æ‰“å¼€Isaac Simçª—å£
# 2. æ˜¾ç¤º1ä¸ªæœºå™¨äºº
# 3. è‡ªåŠ¨åŠ è½½æœ€æ–°æ¨¡å‹
# 4. å®æ—¶ç»Ÿè®¡å¥–åŠ±
```

### APIå…¼å®¹æ€§æµ‹è¯•
- âœ… æ”¯æŒ4ä¸ªè¿”å›å€¼ï¼ˆæ—§ç‰ˆï¼‰
- âœ… æ”¯æŒ5ä¸ªè¿”å›å€¼ï¼ˆæ–°ç‰ˆï¼‰
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶é€‚é…

---

## ç›¸å…³æ–‡æ¡£

- Isaac Labå®˜æ–¹æ–‡æ¡£: https://isaac-sim.github.io/IsaacLab/
- RSL-RLæ–‡æ¡£: /leggedrobotics/rsl_rl
- Commit: c3ad119 (æœ€ç»ˆä¿®å¤ç‰ˆæœ¬)

---

**åˆ›å»ºæ—¶é—´**: 2026-01-26 03:50
**æœ€åæ›´æ–°**: 2026-01-26 04:15
**è®°å½•è€…**: Claude Code AI System
**çŠ¶æ€**: âœ… é—®é¢˜å·²è§£å†³å¹¶æ–‡æ¡£åŒ–
**æœ€ç»ˆç‰ˆæœ¬**: v5.1 (commit dcb8062)
**ä¸‹ä¸€æ­¥**: ç”¨æˆ·æµ‹è¯•play.pyåŠŸèƒ½

**ä¿®å¤å†ç¨‹æ€»ç»“**:
- v1.0 â†’ v3.0: ç»•è¿‡OnPolicyRunnerï¼Œç›´æ¥ä½¿ç”¨ActorCritic
- v3.1: å…¼å®¹step()è¿”å›å€¼æ•°é‡å˜åŒ–ï¼ˆ4â†’5ï¼‰
- v3.2 â†’ v4.0: ä¿®å¤ActorCriticç­¾ååŒ¹é…
- v5.1: æ·»åŠ obs_groups["critic"]é”®
- æ€»è¿­ä»£: 6ä¸ªç‰ˆæœ¬ï¼Œå†æ—¶1.5å°æ—¶
