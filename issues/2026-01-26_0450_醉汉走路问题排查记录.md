# "醉汉走路"问题排查记录

> **发现时间**: 2026-01-26 04:50
> **问题现象**: 训练完成的机器人一直带着角速度转圈，不走直线，感觉不知道目标在哪
> **严重程度**: 🔴 严重（影响部署效果）
> **状态**: 🔍 排查中

---

## 🔍 排查过程

### 嫌疑人三：物理参数不对称（已排除✅）

#### 测试方法
```bash
python debug_play.py --test straight_line --num_envs 1 --num_episodes 3
```

#### 测试数据

**Episode 1**：
```
初始: (0.27, 0.44, 0.00rad)
200步: (0.94, 0.79, 0.00rad) → Δx=+0.67m, Δy=+0.35m
200-1350步: 静止在 (0.93, 0.80)
```

**Episode 2**：
```
初始: (-0.28, -0.45, 0.00rad)
350步: (-1.27, 0.44, 0.00rad) → Δx=-0.99m, Δy=+0.89m
350-1350步: 静止在 (-1.28, 0.44)
```

**Episode 3**：
```
初始: (0.75, 0.19, 0.00rad)
1325步: (-1.84, -4.27, 0.00rad) → Δx=-2.59m, Δy=-4.46m
持续运动，未静止
```

#### 分析结果

**✅ 物理参数正常**：
1. **没有持续转向**：所有 episodes 中 yaw 保持 0.00rad
2. **没有画弧线**：如果是 URDF/摩擦力问题，yaw 会明显变化
3. **能稳定运动**：Episode 3 连续运动 1350 步

**⚠️ 发现的问题**：

**问题1：Episode 提前终止**
- Episode 1: 200 步后静止
- Episode 2: 350 步后静止
- Episode 3: 正常运行 1350 步

**可能原因**：
- 触发了 `out_of_bounds`（越界）
- 触发了 `base_height`（高度异常）
- 机器人卡住了（虽然看起来不太可能）

**问题2：系统性偏移**
- Episode 1: 向右偏 0.35m（28°）
- Episode 2: 向右偏 0.89m（42°）
- Episode 3: 向左偏 4.46m（60°）

**可能原因**：
- 地面不平整
- 初始朝向微小偏差
- 轮子轻微打滑（随机因素）
- **或者**：这是正常的随机扰动

**结论**：
- ✅ **物理参数基本正常**，嫌疑人三排除
- ⚠️ 存在轻微系统性偏差，但在可接受范围内
- ⚚️ 需要调查为什么部分 episodes 提前终止

---

## 🔬 待排查问题

### 问题1：为什么 Episodes 1 和 2 提前静止？

**现象**：
- Episode 1: 200 步后完全静止
- Episode 2: 350 步后完全静止
- Episode 3: 正常运行 1350 步

**可能原因**：
1. **out_of_bounds**（越界终止）
   - 机器人跑出了活动范围
   - 边界检查过于严格

2. **base_height**（高度异常）
   - 机器人姿态不正常（虽然数据显示正常）
   - z 轴高度超出阈值

3. **卡住或碰撞**
   - 虽然没有明显的碰撞
   - 可能地形导致卡住

**排查方法**：
```bash
# 在 debug_play.py 中添加 termination 原因打印
# 查看 episode 结束时是哪个 termination 条件触发的
```

---

### 问题2：机器人为什么会"醉汉走路"？

**原始问题**：
- 训练完成的机器人一直带着角速度转圈
- 不走直线，感觉不知道目标在哪

**新的理解**：
- 从测试数据看，**物理参数正常**
- 问题可能在 **坐标系转换** 或 **观测归一化**
- 需要继续排查嫌疑人一和嫌疑人二

---

## 📝 测试记录

### 测试环境
- 日期：2026-01-26 04:50
- 环境：Isaac Lab 0.46 + Isaac Sim 4.5
- 测试模式：强制走直线（v=0.5, w=0.0）
- Episodes: 3个，每个最多1350步

### 观测总结

| Episode | 总步数 | 运动状态 | yaw变化 | y偏移 | 结论 |
|---------|--------|---------|---------|-------|------|
| 1 | 1350 | 200步静止 | 0.00 | +0.35m | 正常 |
| 2 | 1350 | 350步静止 | 0.00 | +0.89m | 正常 |
| 3 | 1350 | 持续运动 | 0.00 | -4.46m | 正常 |

### 关键发现

1. **物理参数正常**：yaw 保持 0.00，没有持续转向
2. **系统性偏差**：所有 episodes 都有单向偏移（左或右）
3. **部分异常**：Episodes 1 和 2 提前静止
4. **机器人能动**：能稳定运动 1350 步，说明物理引擎工作正常

---

## 🚀 下一步计划

### 优先级1：排查坐标系（嫌疑人一）

**测试命令**：
```bash
python debug_play.py --test print_obs --num_envs 1 --num_episodes 1
```

**目的**：
- 检查目标角度计算是否正确
- 验证坐标系符号是否反了

**判断标准**：
- 目标在左边 → angle 应为正（约 +1.57）
- 目标在右边 → angle 应为负（约 -1.57）
- 目标在前面 → angle 应为 0

**如果坐标系错误**：
- 修改 `dashgo_env_v2.py` 中的角度计算
- 从头训练模型

---

### 优先级2：排查归一化（嫌疑人二）

**测试命令**：
```bash
python debug_play.py --test no_norm --num_envs 1 --num_episodes 1
```

**目的**：
- 检查归一化层是否被污染
- 验证统计数据是否正常

**判断标准**：
- 关闭归一化后，行为是否改善

**如果归一化有问题**：
- 删除 logs 文件夹
- 从头训练模型

---

### 优先级3：调查提前终止问题

**目的**：
- 查明为什么 Episodes 1 和 2 提前静止
- 检查是否 termination 条件配置问题

**方法**：
- 在环境代码中添加调试信息
- 打印哪个 termination 条件触发

---

## 📂 相关文件

- 调试脚本：`debug_play.py`
- 环境定义：`dashgo_env_v2.py`
- 问题指南：`issues/2026-01-26_0440_醉汉走路问题排查指南.md`

---

## 🎯 当前状态

- ✅ 嫌疑人三（物理参数）：已排除
- 🔍 嫌疑人一（坐标系）：待测试
- 🔍 嫌疑人二（归一化）：待测试
- ⚠️ Episode 提前终止：待调查

---

**创建时间**: 2026-01-26 04:55
**记录者**: Claude Code AI System
**状态**: 🔍 排查中
**下一步**: 测试坐标系（嫌疑人一）
