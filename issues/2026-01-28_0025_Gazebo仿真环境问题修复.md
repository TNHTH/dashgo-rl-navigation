# Gazebo仿真环境问题修复 - 白色圆柱+TF断裂+RViz黑屏

> **创建时间**: 2026-01-28 00:25:00
> **严重程度**: 🟡 部署阻塞
> **状态**: ✅ 已修复（待验证）
> **相关文件**: dashgo_d1_sim.urdf.xacro

---

## 问题描述

### 现象1：Gazebo显示白色圆柱堆叠
**描述**: Gazebo中只出现白色圆柱，没有精细的机器人模型

**原因**:
- URDF使用简化几何体（cylinder）作为visual
- 缺少精细3D模型文件（.stl或.dae）
- **不影响功能**，只是视觉不好看

### 现象2：RViz黑屏+TF报错
**错误信息**:
```
RobotModel Error:
- base_link: "No transform from [base_link] to [odom]"
- laser_link: "No transform from [laser_link] to [odom]"
- left_wheel_link: "No transform from [left_wheel_link] to [odom]"
- right_wheel_link: "No transform from [right_wheel_link] to [odom]"
```

**原因**:
- URDF中缺少Gazebo差速驱动插件
- 没有节点发布odom→base_link的TF变换
- **致命问题**：无法定位、无法控制

### 现象3：RViz LaserScan无数据
**描述**: LaserScan插件的Topic为空

**原因**:
- URDF中缺少Gazebo激光传感器插件
- 没有/scan话题发布

---

## 解决方案

### 修复1：创建meshes文件夹

**位置**: `~/dashgo_rl_project/catkin_ws/src/dashgo_rl/meshes/`

**说明**: 占位符文件夹，为将来添加精细3D模型预留

### 修复2：添加Gazebo差速驱动插件（关键）

**文件**: `dashgo_d1_sim.urdf.xacro`
**位置**: 第151-186行

**插件配置**:
```xml
<gazebo>
  <plugin name="differential_drive_controller" filename="libgazebo_ros_diff_drive.so">
    <updateRate>50</updateRate>
    <leftJoint>left_wheel_joint</leftJoint>
    <rightJoint>right_wheel_joint</rightJoint>
    <wheelSeparation>0.342</wheelSeparation>
    <wheelDiameter>0.1264</wheelDiameter>
    <wheelAcceleration>1.0</wheelAcceleration>
    <wheelTorque>20</wheelTorque>
    <commandTopic>cmd_vel</commandTopic>
    <odometryTopic>odom</odometryTopic>
    <odometryFrame>odom</odometryFrame>
    <robotBaseFrame>base_link</robotBaseFrame>
    <odometrySource>world</odometrySource>
    <publishWheelTF>true</publishWheelTF>
    <publishOdomTF>true</publishOdomTF>
    <publishWheelJointState>true</publishWheelJointState>
  </plugin>
</gazebo>
```

**功能**:
- ✅ 发布odom→base_link TF变换（解决TF报错）
- ✅ 订阅/cmd_vel话题（接收速度命令）
- ✅ 发布/odom话题（提供里程计数据）

### 修复3：添加激光雷达插件

**文件**: `dashgo_d1_sim.urdf.xacro`
**位置**: 第188-217行

**插件配置**:
```xml
<gazebo reference="laser_link">
  <sensor type="ray" name="laser_sensor">
    <ray>
      <scan>
        <horizontal>
          <samples>360</samples>
          <min_angle>-3.14159</min_angle>
          <max_angle>3.14159</max_angle>
        </horizontal>
      </scan>
      <range>
        <min>0.10</min>
        <max>12.0</max>
      </range>
    </ray>
    <plugin name="laser_controller" filename="libgazebo_ros_laser.so">
      <topicName>/scan</topicName>
      <frameName>laser_link</frameName>
    </plugin>
  </sensor>
</gazebo>
```

**功能**:
- ✅ 发布/scan话题（激光雷达数据）
- ✅ 360度扫描，12m范围
- ✅ 添加高斯噪声（模拟真实雷达）

---

## 参数说明

### 关键参数对齐

| 参数 | URDF值 | ROS配置值 | 说明 |
|------|--------|-----------|------|
| **轮距** | 0.342 m | 0.3420 m | ✅ 完全对齐 |
| **轮径** | 0.1264 m | 0.1264 m | ✅ 完全对齐 |
| **轮半径** | 0.0632 m | 0.0632 m | ✅ 完全对齐 |
| **更新频率** | 50 Hz | 20 Hz | ⚠️ Gazebo更高（平滑仿真） |
| **最大力矩** | 20 Nm | - | 根据DashGo参数 |
| **最大加速度** | 1.0 m/s² | 1.0 m/s² | ✅ 对齐launch文件 |

### TF坐标系树

```
odom (里程计坐标系)
  └─ base_link (机器人基座)
      ├─ left_wheel_link (左轮)
      ├─ right_wheel_link (右轮)
      └─ laser_link (雷达)
```

---

## 验证方法

### 1. 检查TF树

```bash
rosrun tf view_frames
# 应生成frames.pdf，显示完整的TF树
```

### 2. 检查话题

```bash
# 应该有这些话题
rostopic list | grep -E "odom|scan|cmd_vel"

# 应该输出：
# /cmd_vel
# /odom
# /scan
```

### 3. 检查TF变换

```bash
# 不应该报错
rosrun tf tf_echo odom base_link

# 应该输出变换矩阵
```

### 4. RViz显示

- ✅ RobotModel全绿（无TF错误）
- ✅ Fixed Frame设为odom或map
- ✅ LaserScan选择/scan话题
- ✅ 能看到红色点云
- ✅ 能看到蓝色圆形底盘

---

## 预期结果

### Gazebo仿真
- ✅ 仍然是白色圆柱（简化模型）
- ✅ 机器人可以通过/cmd_vel控制
- ✅ 机器人会发布里程计数据
- ✅ 雷达会扫描环境

### RViz可视化
- ✅ 不再黑屏（调整视角后）
- ✅ 无TF报错
- ✅ 能看到激光点云（红色）
- ✅ 能看到机器人轨迹

### ROS节点
- ✅ geo_nav_node正常运行
- ✅ 能接收/scan数据
- ✅ 能发布/cmd_vel命令
- ✅ 能读取/odom数据

---

## 已知限制

### 视觉问题
- **白色圆柱**：这是简化几何模型，不影响功能
- **解决方案**：将来可以添加.stl或.dae精细模型

### RViz视角
- **黑屏**：通常是因为摄像机没有对准机器人
- **解决方案**：
  1. 点击RobotModel
  2. 点击工具栏的"Focus Camera"按钮
  3. 或者鼠标滚轮缩放、Shift+左键平移

---

## 经验教训

### 1. URDF必须包含Gazebo插件
**教训**: 仅定义几何体是不够的，必须添加仿真插件才能：
- 发布TF变换
- 订阅控制命令
- 发布传感器数据

### 2. 差速驱动插件是核心
**教训**: libgazebo_ros_diff_drive.so是移动机器人的"神经系统"：
- 没有它 = 没有TF = 无法定位
- 没有它 = 不订阅cmd_vel = 无法控制

### 3. meshes文件夹占位符
**教训**: 即使没有精细模型，也应该创建meshes文件夹：
- 规范化项目结构
- 为将来升级预留空间
- 避免URDF解析错误

---

## 相关文档

- **URDF文件**: `catkin_ws/src/dashgo_rl/urdf/dashgo_d1_sim.urdf.xacro`
- **Launch文件**: `catkin_ws/src/dashgo_rl/launch/sim2real_golden.launch`
- **机器人参数**: `docs/dashgo-robot-specifications_2026-01-24.md`
- **Sim2Real指南**: `docs/DashGo-完全复现指南_v5.0_2026-01-28.md`

---

## 待验证

- [ ] 重新启动roslaunch
- [ ] 确认Gazebo中机器人可以移动
- [ ] 确认RViz不再报TF错误
- [ ] 确认RViz能看到激光点云
- [ ] 测试geo_nav_node是否能导航

---

**修复者**: Claude Code AI Assistant (基于Isaac Sim架构师诊断)
**状态**: ✅ 代码已修复，等待用户验证
**创建时间**: 2026-01-28 00:25:00
