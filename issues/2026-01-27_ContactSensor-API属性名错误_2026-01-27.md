# ContactSensor API 属性名错误

> **创建时间**: 2026-01-27 16:10:00
> **严重程度**: 🟡 API错误
> **状态**: ✅ 已解决
> **错误类型**: AttributeError - ContactSensor 属性不存在
> **相关文件**: dashgo_env_v2.py

---

## 🚨 错误信息

### 完整错误堆栈

```
Traceback (most recent call last):
  File "/home/gwh/dashgo_rl_project/verify_collision.py", line 60, in main
    step_result = env.step(action)
  ...
  File "/home/gwh/dashgo_rl_project/dashgo_env_v2.py", line 447, in penalty_undesired_contacts
    contact_data = env.scene[sensor_cfg.name].data.net_contact_forces
AttributeError: 'ContactSensorData' object has no attribute 'net_contact_forces'
```

### 执行命令

```bash
~/IsaacLab/isaaclab.sh -p verify_collision.py --headless --enable_cameras
```

---

## 🔍 问题分析

### 根本原因

**架构师诊断**：
> 这是一个非常经典的 **API 属性名错误**。你离成功只有一行代码的距离！
>
> **原因**：在 Isaac Lab 中，`ContactSensor`（接触传感器）的数据对象 `ContactSensorData` 存储力的属性名是 **`net_forces_w`** (Net Forces in World Frame)，而不是 `net_contact_forces`。

**详细解释**：

1. **属性名差异**：
   - ❌ **错误**：`data.net_contact_forces`
   - ✅ **正确**：`data.net_forces_w`

2. **API 来源**：
   - `net_contact_forces`：通常是旧版 API 或 `RigidBody` 视图中的属性
   - `net_forces_w`：`ContactSensor` 特有的属性（世界坐标系下的合力）

3. **数据形状**：
   - `data.net_forces_w` 的形状是 `[num_envs, 3]`
   - 每个环境有3个分量（x, y, z 方向的力）

---

## ✅ 解决方案

### 修改文件：dashgo_env_v2.py

**位置**：`penalty_undesired_contacts` 函数（第447行）

**修改前**（错误）：
```python
# 获取接触力数据
contact_data = env.scene[sensor_cfg.name].data.net_contact_forces  # ❌ 错误的属性名
```

**修改后**（正确）：
```python
# [Fix 2026-01-27] 使用正确的属性名 net_forces_w
# Isaac Lab ContactSensor 的属性名是 net_forces_w，而非 net_contact_forces
contact_data = env.scene[sensor_cfg.name].data.net_forces_w  # ✅ 正确
```

**完整修正后的函数**：
```python
def penalty_undesired_contacts(env: ManagerBasedRLEnv, sensor_cfg: SceneEntityCfg, threshold: float = 0.1) -> torch.Tensor:
    """
    [v8.0] 轻微接触惩罚 - 第二层防御
    """
    # [Fix 2026-01-27] 使用正确的属性名 net_forces_w
    # Isaac Lab ContactSensor 的属性名是 net_forces_w，而非 net_contact_forces
    # data.net_forces_w 的形状是 [num_envs, 3]
    contact_data = env.scene[sensor_cfg.name].data.net_forces_w  # [N, 3]
    force_mag = torch.norm(contact_data, dim=-1)  # [N]

    # 任何超过阈值的接触都给予惩罚
    has_contact = force_mag > threshold

    # 返回惩罚（轻微扣分，权重由 RewardsCfg 控制）
    return -torch.where(has_contact, 1.0, 0.0)
```

---

## 📊 技术细节

### Isaac Lab 传感器数据结构

#### ContactSensor vs RigidBody

**RigidBody 视图**：
```python
# 对于 RigidBody 对象（如机器人本体）
robot.data.net_contact_forces  # ❌ 不适用 ContactSensor
```

**ContactSensor 视图**：
```python
# 对于 ContactSensor 对象
sensor.data.net_forces_w  # ✅ 正确（世界坐标系下的合力）
```

### 属性命名规范

| 数据类型 | 属性名 | 含义 | 形状 |
|---------|--------|------|------|
| **ContactSensor** | `net_forces_w` | 世界坐标系下的合力 | [N, 3] |
| **RigidBody** | `net_contact_forces` | 网格接触力 | [N, num_bodies, 3] |

**关键差异**：
- `ContactSensor` 专用于检测接触力
- `RigidBody` 用于刚体动力学，包含更多物理状态

---

## 🎓 经验教训

### 1. Isaac Lab API 版本差异

**教训**：不同数据类型有不同的属性名
- 不能假设所有传感器都有相同的属性
- 必须查看官方文档或源码确认属性名

**参考**：
- Isaac Lab 官方文档：`ContactSensor` 类定义
- 源码：`isaaclab/sensors/contact/contact_sensor.py`

### 2. 属性名后缀含义

**教训**：属性名后缀有明确含义
- `_w`：World Frame（世界坐标系）
- `_b`：Body Frame（物体坐标系）

**示例**：
- `root_lin_vel_w`：世界坐标系下的线速度
- `root_lin_vel_b`：物体坐标系下的线速度

### 3. 调试技巧

**教训**：遇到 AttributeError 时
1. 检查数据类型（`type(env.scene[sensor_name].data)`）
2. 查看可用属性（`dir(env.scene[sensor_name].data)`）
3. 对比官方示例代码

---

## 🔧 实施记录

### 修改文件
- `dashgo_env_v2.py`：修改 `penalty_undesired_contacts()` 函数

### 修改内容
- 第447行：`net_contact_forces` → `net_forces_w`
- 添加详细注释说明属性名差异

### 相关提交
- commit: 7d7b5b7 (2026-01-27)

---

## 🚀 验证方法

### 再次运行碰撞测试

修改完成后，运行验证脚本：

```bash
~/IsaacLab/isaaclab.sh -p verify_collision.py --headless --enable_cameras
```

**预期输出**（成功）：
```text
Step 40: 速度=0.28 m/s | 接触力=12.3421 N | Done=False
...
🛑 [检测到重置] 在 Step XX 触发！
--------------------------------------------------
🕵️‍♂️ 重置原因取证:
   > 碰撞 (object_collision): 1.0  ← 关键指标
   > 翻车 (base_height):      0.0
   > 超时 (time_out):         0.0
--------------------------------------------------
✅ 验证成功：系统检测到了碰撞并触发了重置！
```

**如果验证成功**：
- ✅ 三层防御体系已完全部署
- ✅ 碰撞检测工作正常
- ✅ 可以开始大规模训练

---

## 📚 相关文档

- **三层防御体系**：`issues/2026-01-27_避障策略优化-三层防御体系_2026-01-27.md`
- **实施记录**：`issues/2026-01-27_Geo-Distill-V2.2实施记录.md`
- **验证脚本**：`verify_collision.py`

---

**维护者**: Claude Code AI System (Robot-Nav-Architect Agent)
**项目**: DashGo机器人导航（Sim2Real）
**开发基准**: Isaac Sim 4.5 + Ubuntu 20.04
**状态**: ✅ 已解决，待验证
