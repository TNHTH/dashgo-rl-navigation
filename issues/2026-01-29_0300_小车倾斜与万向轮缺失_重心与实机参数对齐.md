# 小车倾斜与万向轮缺失问题

> **创建时间**: 2026-01-29 03:00:00
> **严重程度**: 🟡 警告（稳定性问题）
> **状态**: ✅ 已修复
> **相关文件**: dashgo_d1_sim.urdf.xacro
> **参考文档**: Dashgo D1产品简介

---

## 问题描述

### 问题1：小车朝一边倒下（倾斜）

**症状**:
- ❌ 小车在Gazebo中不稳定，朝一边倾斜
- ❌ 重心位置与碰撞体不对齐
- ❌ 物理仿真不稳定

### 问题2：缺少万向轮

**症状**:
- ❌ 只有2个驱动轮，缺少支撑
- ❌ 小车稳定性差，容易侧翻
- ❌ 与实机布局不符

**背景**:
- 用户提供了Dashgo D1完整参数
- 实机采用1+2+1布局（前万向+中驱动+后万向）
- 当前仿真只有2个驱动轮，缺少前后支撑

---

## 🎯 Dashgo D1 实机参数

### 关键技术参数

**整机性能**:
- 最大运行速度：0.8 m/s
- 载重能力：30 kg
- 自身重量：20 kg
- 续航时间：约 4 小时

### 结构尺寸与物理特性

**尺寸**:
- 整机尺寸：406mm × 406mm × 209.5mm
- 底盘直径：Ø 406mm
- 离地高度：38 mm

**轮子系统**:
- 驱动轮：4寸橡胶轮（直径=0.1264m）
- 万向轮：1寸（半径=12.7mm）
- 轮子布局：**1+2+1**（前万向 + 中驱动 + 后万向）

**主结构**:
- 材料：钢材
- 驱动方式：直流有刷电机
- 减速比：30

### 导航模块

**传感器**:
- 激光雷达：EAI G4
- 避障传感器：超声波模块 × 4
- IMU：内置PS1000C模块
- 编码器：600线增量型光电编码器

**软件功能**:
- Gmapping建图（300平米以内）
- 单雷达导航、超声波避障、陀螺仪融合
- 路径规划、局部路径优化

---

## 🧠 诊断分析

### 问题1诊断：重心位置错误

**旧配置**:
```xml
<collision>
  <origin xyz="0 0 0.05" rpy="0 0 0"/>  <!-- 碰撞体抬高 -->
</collision>

<inertial>
  <mass value="${base_mass}"/>
  <inertia .../>
  <!-- 没有origin，重心默认在(0,0,0) -->
</inertial>
```

**问题分析**:
```
碰撞体中心：z = 0.05m
重心（inertial）：z = 0.00m
重心偏低，碰撞体偏高 → 头重脚轻 → 不稳定 ❌
```

### 问题2诊断：缺少万向轮

**实机布局** vs 仿真布局：

| 位置 | Dashgo D1 实机 | 仿真（旧） |
|------|----------------|-----------|
| 前方 | 万向轮（1寸） | 无 ❌ |
| 中间 | 驱动轮（4寸）×2 | 驱动轮×2 ✅ |
| 后方 | 万向轮（1寸） | 无 ❌ |

**稳定性问题**:
- 只有2个驱动轮支撑 → 稳定性差
- 缺少前后支撑点 → 容易侧翻
- 与实机布局不符 → Sim2Real偏差

---

## 💡 解决方案

### 修复1：对齐重心与碰撞体

**修改inertial，添加origin**:

```xml
<!-- 修改前 -->
<inertial>
  <mass value="${base_mass}"/>
  <inertia ixx="0.05" .../>
</inertial>

<!-- 修改后 -->
<inertial>
  <origin xyz="0 0 0.05" rpy="0 0 0"/>  <!-- 跟随碰撞体 -->
  <mass value="${base_mass}"/>
  <inertia ixx="0.05" .../>
</inertial>
```

**效果**:
- 重心：z = 0.05m
- 碰撞体中心：z = 0.05m
- **结论**：重心与碰撞体对齐，物理稳定 ✅

### 修复2：添加万向轮（1+2+1布局）

**参数定义**:
```xml
<xacro:property name="caster_radius" value="0.0127"/>   <!-- 1寸=12.7mm -->
<xacro:property name="caster_mass" value="0.1"/>
```

**前万向轮**:
```xml
<link name="front_caster_link">
  <visual>
    <geometry>
      <sphere radius="${caster_radius}"/>
    </geometry>
    <material name="gray">
      <color rgba="0.5 0.5 0.5 1.0"/>
    </material>
  </visual>
  <collision>
    <geometry>
      <sphere radius="${caster_radius}"/>
    </geometry>
  </collision>
  <inertial>
    <mass value="${caster_mass}"/>
    <inertia ixx="0.00001" .../>
  </inertial>
</link>

<joint name="front_caster_joint" type="fixed">
  <parent link="base_link"/>
  <child link="front_caster_link"/>
  <origin xyz="0.15 0 -0.05" rpy="0 0 0"/>  <!-- 底盘前方 -->
</joint>
```

**后万向轮**（类似，position改为xyz="-0.15 0 -0.05"）

**万向轮摩擦力**（低摩擦便于转向）:
```xml
<gazebo reference="front_caster_link">
  <mu1>0.0</mu1>  <!-- 低摩擦 -->
  <mu2>0.0</mu2>
  <kp>1000000.0</kp>
  <kd>100.0</kd>
  <minDepth>0.001</minDepth>
  <material>Gazebo/Grey</material>
</gazebo>
```

---

## ✅ 验证方法

### 1. 检查重心对齐

**Gazebo观察**:
- ✅ 小车不再倾斜
- ✅ 稳定站立
- ✅ 重心与碰撞体中心一致

### 2. 检查万向轮

**Gazebo观察**:
- ✅ 看到4个轮子（前万向 + 2驱动 + 后万向）
- ✅ 所有轮子接触地面
- ✅ 1+2+1布局符合实机

**TF树验证**:
```bash
rosrun tf tf_echo base_link front_caster_link
rosrun tf tf_echo base_link rear_caster_link
```

### 3. 测试移动

**RViz 2D Nav Goal**:
- ✅ 小车能正常移动
- ✅ 不再侧翻
- ✅ 转向稳定

---

## 🎓 经验教训

### 1. Inertial和Collision必须对齐

**教训**:
- inertial定义重心，collision定义物理体积
- 两者origin必须一致，否则头重脚轻
- 物理引擎会根据inertial计算动力学

**最佳实践**:
```xml
<collision>
  <origin xyz="0 0 0.05" .../>
</collision>

<inertial>
  <origin xyz="0 0 0.05" .../>  <!-- 必须一致！ -->
</inertial>
```

### 2. 万向轮的重要性

**教训**:
- 差速驱动机器人通常需要支撑点
- 1+2+1或2+2布局常见
- 万向轮提供稳定性，防止侧翻

**实机参考**:
- Dashgo D1：1+2+1（前万向 + 中驱动 + 后万向）
- TurtleBot：2驱动轮 + 1后万向轮
- 大部分扫地机器人：2驱动 + 多万向轮

### 3. 低摩擦万向轮

**教训**:
- 万向轮摩擦力必须低（mu1=0, mu2=0）
- 否则会影响转向
- 驱动轮摩擦力要高（mu1=1.0, mu2=1.0）

**参数对比**:
```
驱动轮（需要抓地力）:
  mu1=1.0, mu2=1.0

万向轮（需要转向）:
  mu1=0.0, mu2=0.0
```

### 4. Sim2Real参数对齐

**关键参数来源**:
- `dashgo/EAI驱动/dashgo_bringup/config/my_dashgo_params.yaml`
- Dashgo D1产品简介（用户提供）

**必须对齐的参数**:
- 轮距：0.3420m
- 轮径：0.1264m（半径0.0632m）
- 轮子布局：1+2+1
- 自重：20kg（base_mass）

---

## 🔗 相关文档

- **Dashgo参数**: `dashgo/EAI驱动/dashgo_bringup/config/my_dashgo_params.yaml`
- **相关问题**:
  - `2026-01-29_0240_轮子悬空无法移动_底盘拖底Bottoming_Out.md`
  - `2026-01-29_0120_轮子穿模卡死_碰撞体积冲突.md`

---

## 🔗 相关Commit

- `b4bf5ce` - feat: 修复重心位置并添加万向轮(Dashgo D1实机参数) ✅

---

## 📝 验证清单

**修改前**:
- [x] 确认小车倾斜（重心问题）
- [x] 确认缺少万向轮（稳定性问题）
- [x] 查阅Dashgo D1实机参数

**修改后**:
- [ ] 重启roslaunch加载新URDF
- [ ] Gazebo中检查小车是否稳定（不再倾斜）
- [ ] 确认4个轮子着地（前万向+2驱动+后万向）
- [ ] RViz中测试2D Nav Goal
- [ ] 验证TF树包含front_caster_link和rear_caster_link

---

**维护者**: Claude Code AI Assistant
**状态**: 等待用户验证修复效果
