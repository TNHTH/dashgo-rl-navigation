# è®­ç»ƒå¯åŠ¨å¤±è´¥ï¼šé…ç½®é”™è¯¯ä¸Headlesså¤±æ•ˆ

> **åˆ›å»ºæ—¶é—´**: 2026-01-24 17:26:00
> **é—®é¢˜ç±»å‹**: Bug
> **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸¥é‡ï¼ˆé˜»å¡è®­ç»ƒï¼‰
> **çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ“‹ é—®é¢˜æè¿°

å¯åŠ¨è®­ç»ƒæ—¶é‡åˆ°ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

1. **KeyError: 'num_steps_per_env'** - RSL-RL é…ç½®ç»“æ„ä¸åŒ¹é…
2. **--headless å‚æ•°å¤±æ•ˆ** - Isaac Sim çª—å£ä»ç„¶å¼¹å‡º

---

## ğŸ” é—®é¢˜1ï¼šé…ç½® KeyError

### é”™è¯¯ä¿¡æ¯
```python
Traceback (most recent call last):
  File "/home/gwh/dashgo_rl_project/train_v2.py", line 194, in main
    runner = OnPolicyRunner(env, agent_cfg, log_dir=log_dir, device=device)
  File "/home/gwh/.conda/envs/env_isaaclab/lib/python3.10/site-packages/rsl_rl/runners/on_policy_runner.py", line 36, in __init__
    self.num_steps_per_env = self.cfg["num_steps_per_env"]
KeyError: 'num_steps_per_env'
```

### æ ¹æœ¬åŸå› 

**YAML ç»“æ„**ï¼š
```yaml
# train_cfg_v2.yaml
runner:
  num_steps_per_env: 24  # åµŒå¥—åœ¨ runner ä¸‹
```

**Python åŠ è½½**ï¼š
```python
train_cfg = yaml.safe_load(f)
# ç»“æœï¼š{'runner': {'num_steps_per_env': 24, ...}, ...}
```

**RSL-RL æœŸæœ›**ï¼š
```python
# rsl_rl/runners/on_policy_runner.py:36
self.num_steps_per_env = self.cfg["num_steps_per_env"]  # ç›´æ¥åœ¨æ ¹ç›®å½•æ‰¾
```

**é—®é¢˜**ï¼šRSL-RL ç›´æ¥åœ¨æ ¹ç›®å½•æŸ¥æ‰¾ `num_steps_per_env`ï¼Œä½†å®ƒåœ¨ `runner` å­ç›®å½•ä¸‹ã€‚

### è§£å†³æ–¹æ¡ˆ

**ä¿®å¤ä»£ç **ï¼š
```python
# å°† runner é‡Œçš„å‚æ•°æå–åˆ°æ ¹ç›®å½•
agent_cfg = train_cfg.copy()
if "runner" in agent_cfg:
    runner_cfg = agent_cfg.pop("runner")
    agent_cfg.update(runner_cfg)  # æŠŠ num_steps_per_env æåˆ°æ ¹ç›®å½•
```

---

## ğŸ¨ é—®é¢˜2ï¼šHeadless å¤±æ•ˆ

### é”™è¯¯ç°è±¡
- ç”¨æˆ·è¾“å…¥ï¼š`~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80`
- **ç»“æœ**ï¼šä»ç„¶å¼¹å‡º Isaac Sim çª—å£æ˜¾ç¤ºåœºæ™¯

### æ ¹æœ¬åŸå› 

**åŸå› **ï¼š`train_v2.py` æ²¡æœ‰å‚æ•°è§£æï¼ˆArgumentParserï¼‰æ¨¡å—

**æœºåˆ¶**ï¼š
1. `isaaclab.sh` ä¼ é€’ `--headless` å‚æ•°ç»™ Python è„šæœ¬
2. ä½† `train_v2.py` æ²¡æœ‰ä»£ç "è¯»å–"è¿™ä¸ªå‚æ•°
3. ä»¿çœŸå™¨é»˜è®¤ä»¥ GUI æ¨¡å¼å¯åŠ¨

**é”™è¯¯ä»£ç **ï¼š
```python
# train_v2.py (æ—§ç‰ˆ)
import gymnasium as gym
from omni.isaac.lab.envs import ManagerBasedRLEnv

# âŒ ç¼ºå°‘ AppLauncher å’Œ ArgumentParser
# âŒ ç›´æ¥å¯¼å…¥ Isaac Labï¼Œå¯¼è‡´çª—å£å¼¹å‡º
```

### è§£å†³æ–¹æ¡ˆ

**æ­£ç¡®é¡ºåº**ï¼š
```python
# 1. åœ¨å¯¼å…¥ä»»ä½• omni/isaac æ¨¡å—ä¹‹å‰ï¼Œå…ˆåˆå§‹åŒ– AppLauncher
from omni.isaac.lab.app import AppLauncher

# 2. åˆ›å»ºå‚æ•°è§£æå™¨
parser = argparse.ArgumentParser(description="DashGo RL Training")
parser.add_argument("--headless", action="store_true", default=False)

# 3. è§£æå‚æ•°
args_cli = parser.parse_args()

# 4. å¯åŠ¨ä»¿çœŸåº”ç”¨
app_launcher = AppLauncher(headless=args_cli.headless)
simulation_app = app_launcher.app

# 5. ç„¶åæ‰èƒ½å¯¼å…¥å…¶ä»–åº“
import gymnasium as gym
from omni.isaac.lab.envs import ManagerBasedRLEnv
```

**å…³é”®**ï¼š`AppLauncher` å¿…é¡»åœ¨æ‰€æœ‰ Isaac Lab æ¨¡å—**ä¹‹å‰**å¯¼å…¥å’Œåˆå§‹åŒ–ã€‚

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–‡ä»¶ï¼štrain_v2.py

**å®Œæ•´ä¿®å¤ä»£ç **ï¼š

```python
# train_v2.py
# 2026-01-24: Fixed by Isaac Sim Architect
# ä¿®å¤å†…å®¹ï¼š
# 1. å¢åŠ  ArgumentParser æ”¯æŒ --headless å’Œ --num_envs
# 2. ä¿®å¤ RSL-RL é…ç½® KeyError é—®é¢˜
# 3. æ˜¾å­˜ä¿æŠ¤ï¼šå¯åŠ¨å‰æ¸…ç† CUDA ç¼“å­˜

import argparse
import sys
import os

# [å…³é”®æ­¥éª¤ 1] åœ¨å¯¼å…¥ä»»ä½• omni/isaac æ¨¡å—ä¹‹å‰ï¼Œå…ˆåˆå§‹åŒ– AppLauncher
# è¿™æ˜¯è®© --headless ç”Ÿæ•ˆçš„å”¯ä¸€æ–¹æ³•
from omni.isaac.lab.app import AppLauncher

# åˆ›å»ºå‚æ•°è§£æå™¨
parser = argparse.ArgumentParser(description="DashGo RL Training Script")
parser.add_argument("--headless", action="store_true", default=False, help="Run in headless mode")
parser.add_argument("--num_envs", type=int, default=None, help="Number of environments to simulate")
parser.add_argument("--seed", type=int, default=42, help="Random seed")

# è§£æå‚æ•° (isaaclab.sh ä¼šæŠŠå‚æ•°ä¼ è¿›æ¥)
args_cli = parser.parse_args()

# å¯åŠ¨ä»¿çœŸåº”ç”¨
app_launcher = AppLauncher(headless=args_cli.headless)
simulation_app = app_launcher.app

# [å…³é”®æ­¥éª¤ 2] ä»¿çœŸå™¨å¯åŠ¨åï¼Œå†å¯¼å…¥å…¶ä»–åº“
import gymnasium as gym
import torch
import yaml
from datetime import datetime

# å¯¼å…¥ Isaac Lab å’Œ RSL-RL
from omni.isaac.lab.envs import ManagerBasedRLEnvCfg
from rsl_rl.runners import OnPolicyRunner

# å¯¼å…¥æˆ‘ä»¬çš„ç¯å¢ƒé…ç½®
from dashgo_env_v2 import DashGoEnvCfg

def main():
    """è®­ç»ƒ DashGo å¯¼èˆªç­–ç•¥"""

    # 1. é…ç½®ç¯å¢ƒ
    env_cfg = DashGoEnvCfg()

    # å¦‚æœå‘½ä»¤è¡ŒæŒ‡å®šäº†ç¯å¢ƒæ•°é‡ï¼Œè¦†ç›–é…ç½® (ä½ çš„æ˜¾å¡æ¨è 80-128)
    if args_cli.num_envs is not None:
        env_cfg.scene.num_envs = args_cli.num_envs
    else:
        # é»˜è®¤å€¼ï¼Œé€‚é… 4060 Laptop (8GB VRAM)
        env_cfg.scene.num_envs = 64

    print(f"[Isaac Sim] Env count: {env_cfg.scene.num_envs}, Headless: {args_cli.headless}")

    # 2. åˆ›å»º Isaac Lab ç¯å¢ƒ
    # ç›´æ¥å®ä¾‹åŒ– ManagerBasedRLEnv (æ›´ç¨³å®šçš„æ–¹å¼)
    from omni.isaac.lab.envs import ManagerBasedRLEnv
    env = ManagerBasedRLEnv(cfg=env_cfg)

    # 3. åŠ è½½ RSL-RL è®­ç»ƒé…ç½®
    # ç¡®ä¿ config/train_cfg_v2.yaml è·¯å¾„æ­£ç¡®
    config_path = os.path.join(os.path.dirname(__file__), "config", "train_cfg_v2.yaml")
    # å¦‚æœ config æ–‡ä»¶å¤¹åœ¨åŒçº§ç›®å½•
    if not os.path.exists(config_path):
        config_path = "train_cfg_v2.yaml" # å°è¯•ç›´æ¥è¯»å–å½“å‰ç›®å½•

    with open(config_path, 'r') as f:
        train_cfg = yaml.safe_load(f)

    # [å…³é”®ä¿®å¤ 3] å¤„ç† RSL-RL çš„é…ç½®ç»“æ„é—®é¢˜ (KeyError Fix)
    # RSL-RL éœ€è¦æ‰å¹³åŒ–çš„é…ç½®ï¼Œæˆ‘ä»¬å°† 'runner' é‡Œçš„å†…å®¹æå–åˆ°æœ€å¤–å±‚
    agent_cfg = train_cfg.copy()
    if "runner" in agent_cfg:
        runner_cfg = agent_cfg.pop("runner")
        agent_cfg.update(runner_cfg) # æŠŠ num_steps_per_env æåˆ°æ ¹ç›®å½•

    # ç¡®ä¿ algorithm å’Œ policy ä¹Ÿåœ¨ (é€šå¸¸ YAML é‡Œæœ¬æ¥å°±åœ¨æ ¹ç›®å½•æˆ–è€…è¢«åŒ…å«)
    # æˆ‘ä»¬çš„ YAML ç»“æ„æ˜¯ algorithm: ..., policy: ... æ‰€ä»¥ä¸éœ€è¦é¢å¤–æ“ä½œ

    # 4. åˆå§‹åŒ– Log ç›®å½•
    # ä½¿ç”¨æ—¶é—´æˆ³é˜²æ­¢è¦†ç›–
    run_name = f"{agent_cfg.get('experiment_name', 'dashgo')}_{datetime.now().strftime('%Y-%m-%d_%H-%M-%S')}"
    log_dir = os.path.join("logs", "rsl_rl", run_name)
    os.makedirs(log_dir, exist_ok=True)

    # 5. åˆå§‹åŒ– PPO Runner
    # æ˜¾å­˜ä¼˜åŒ–ï¼šå¼ºåˆ¶æ¸…ç†ä¸€ä¸‹
    torch.cuda.empty_cache()

    runner = OnPolicyRunner(
        env=env,
        train_cfg=agent_cfg, # ä¼ å…¥ä¿®å¤åçš„é…ç½®
        log_dir=log_dir,
        device="cuda:0"
    )

    # 6. å¼€å§‹è®­ç»ƒ
    max_iterations = agent_cfg.get("max_iterations", 1500)
    print(f"[Isaac Sim] Starting training for {max_iterations} iterations...")

    runner.learn(num_learning_iterations=max_iterations, init_at_random_ep_len=True)

    print("[Isaac Sim] Training finished.")
    env.close()

if __name__ == "__main__":
    main()
```

---

## âœ… éªŒè¯æ–¹æ³•

### 1. è¯­æ³•æ£€æŸ¥
```bash
python -m py_compile train_v2.py
```

### 2. é…ç½®æ£€æŸ¥
```bash
python -c "
import yaml
with open('train_cfg_v2.yaml') as f:
    cfg = yaml.safe_load(f)
print('Keys:', list(cfg.keys()))
print('Runner keys:', list(cfg.get('runner', {}).keys()))
"
```

### 3. å¯åŠ¨è®­ç»ƒ
```bash
# ä½¿ç”¨ DISPLAY= é˜²æ­¢çª—å£å¼¹å‡º
DISPLAY= ~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80

# è§‚å¯Ÿè¾“å‡ºï¼š
# - [Isaac Sim] Env count: 80, Headless: True  âœ…
# - [Isaac Sim] Starting training...  âœ…
# âŒ ä¸åº”è¯¥çœ‹åˆ° "Creating window for environment"
```

---

## ğŸ“Š å…³é”®ä¿®å¤ç‚¹æ€»ç»“

### ä¿®å¤1ï¼šé…ç½®æ‰å¹³åŒ–
```python
# âŒ é”™è¯¯ï¼šåµŒå¥—ç»“æ„
agent_cfg = train_cfg  # {'runner': {'num_steps_per_env': 24}}

# âœ… æ­£ç¡®ï¼šæ‰å¹³åŒ–
agent_cfg = train_cfg.copy()
runner_cfg = agent_cfg.pop("runner")
agent_cfg.update(runner_cfg)  # {'num_steps_per_env': 24, ...}
```

### ä¿®å¤2ï¼šAppLauncher åˆå§‹åŒ–é¡ºåº
```python
# âŒ é”™è¯¯ï¼šå…ˆå¯¼å…¥ Isaac Lab
from omni.isaac.lab.envs import ManagerBasedRLEnv
from omni.isaac.lab.app import AppLauncher  # å¤ªæ™šäº†ï¼

# âœ… æ­£ç¡®ï¼šå…ˆåˆå§‹åŒ– AppLauncher
from omni.isaac.lab.app import AppLauncher
app_launcher = AppLauncher(headless=True)
# ç„¶åæ‰èƒ½å¯¼å…¥å…¶ä»–æ¨¡å—
from omni.isaac.lab.envs import ManagerBasedRLEnv
```

### ä¿®å¤3ï¼šå‚æ•°è§£æ
```python
# âŒ é”™è¯¯ï¼šæ²¡æœ‰è§£æ --headless
# è„šæœ¬ç›´æ¥å¯åŠ¨ï¼Œå¿½ç•¥å‚æ•°

# âœ… æ­£ç¡®ï¼šè§£æå‘½ä»¤è¡Œå‚æ•°
parser = argparse.ArgumentParser()
parser.add_argument("--headless", action="store_true")
args_cli = parser.parse_args()
app_launcher = AppLauncher(headless=args_cli.headless)
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80

# ç»“æœï¼š
# 1. å¼¹å‡ºçª—å£ âŒ
# 2. æŠ¥é”™ KeyError âŒ
```

### ä¿®å¤å
```
~/IsaacLab/isaaclab.sh -p train_v2.py --headless --num_envs 80

# ç»“æœï¼š
# [Isaac Sim] Env count: 80, Headless: True  âœ…
# [Isaac Sim] Starting training...  âœ…
# è®­ç»ƒæ­£å¸¸å¼€å§‹  âœ…
```

---

## ğŸ”§ æ˜¾å­˜ä¼˜åŒ–

### RTX 4060 Laptop (8GB) æ¨è

```bash
# ä¿å®ˆé…ç½®ï¼ˆç¨³å®šï¼‰
--num_envs 64

# æ¨èé…ç½®ï¼ˆå¹³è¡¡ï¼‰
--num_envs 80

# æ¿€è¿›é…ç½®ï¼ˆå¯èƒ½OOMï¼‰
--num_envs 128
```

### ç›‘æ§æ˜¾å­˜
```bash
# å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§æ˜¾å­˜
watch -n 1 nvidia-smi
```

---

## ğŸ“ ç»éªŒæ€»ç»“

### å…³é”®è¦ç‚¹

1. **AppLauncher å¿…é¡»æœ€å…ˆå¯¼å…¥**
   - åœ¨æ‰€æœ‰ omni/isaac æ¨¡å—ä¹‹å‰
   - å¦åˆ™ headless å‚æ•°ä¸ç”Ÿæ•ˆ

2. **RSL-RL é…ç½®éœ€è¦æ‰å¹³åŒ–**
   - `runner` å­ç›®å½•çš„å‚æ•°è¦æå–åˆ°æ ¹ç›®å½•
   - ä½¿ç”¨ `pop()` + `update()` å®ç°

3. **å‚æ•°è§£ææ˜¯å¿…é¡»çš„**
   - å¦åˆ™å‘½ä»¤è¡Œå‚æ•°å…¨éƒ¨å¤±æ•ˆ
   - `argparse` æ˜¯æ ‡å‡†åšæ³•

### å¸¸è§é™·é˜±

1. âŒ å¯¼å…¥é¡ºåºé”™è¯¯
2. âŒ é…ç½®ç»“æ„ä¸åŒ¹é…
3. âŒ å¿˜è®°è§£æå‘½ä»¤è¡Œå‚æ•°
4. âŒ é…ç½®æ–‡ä»¶è·¯å¾„é”™è¯¯

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **Isaac Lab æ–‡æ¡£**ï¼š
   - https://isaac-sim.github.io/IsaacLab/main/reference/app.html
   - AppLauncher ä½¿ç”¨æŒ‡å—

2. **RSL-RL æºç **ï¼š
   - rsl_rl/runners/on_policy_runner.py:36
   - é…ç½®ç»“æ„è¦æ±‚

3. **ç›¸å…³é—®é¢˜æ–‡æ¡£**ï¼š
   - `issues/2024-01-24_0128_headlessç›¸æœºprimé”™è¯¯.md`

---

**ç»´æŠ¤è€…**: Claude Code AI Assistant
**æœ€åæ›´æ–°**: 2026-01-24 17:26:00
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶éªŒè¯
**ä¸‹ä¸€æ­¥**: å¯åŠ¨è®­ç»ƒå¹¶ç›‘æ§
