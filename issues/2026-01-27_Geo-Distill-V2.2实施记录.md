# Geo-Distill V2.2 å®æ–½è®°å½•

> **åˆ›å»ºæ—¶é—´**: 2026-01-27 12:00:00
> **ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ åŠŸèƒ½å¢å¼º
> **çŠ¶æ€**: âœ… å·²å®Œæˆ
> **ç›¸å…³æ–‡ä»¶**: dashgo_env_v2.py, geo_nav_policy.py, safety_filter.py, geo_distill_node.py

---

## é—®é¢˜æè¿°

### æ ¸å¿ƒç—›ç‚¹

1. **"é†‰æ±‰èµ°è·¯"ç°è±¡**
   - ä¼ ç»ŸDRLè®­ç»ƒå‡ºçš„ç­–ç•¥åœ¨å®è½¦ä¸Šè¡¨ç°ä¸ºå·¦å³æ‘‡æ‘†ã€å€’è½¦åˆ·åˆ†
   - æ ¹æºï¼šå¥–åŠ±å‡½æ•°è®¾è®¡å†²çªï¼ˆé€Ÿåº¦å¥–åŠ±æƒé‡è¿‡é«˜ä¸”æœªé™åˆ¶æ–¹å‘ï¼‰

2. **æ„ŸçŸ¥å¤±æ•ˆé£é™©**
   - ä»¿çœŸä¸­çš„RayCasterä¼ æ„Ÿå™¨åœ¨å¤„ç†å¤šMeshåœºæ™¯æ—¶å­˜åœ¨æ¶æ„é™åˆ¶
   - å•ç›®ç›¸æœºæ— æ³•ç‰©ç†æ¨¡æ‹Ÿ360Â°å…¨å‘é›·è¾¾
   - æ ¹æºï¼šIsaac LabåŸºäºWarpçš„åŠ é€Ÿå®ç°ä¸æ”¯æŒå¤šMeshæŸ¥è¯¢

3. **ç³»ç»Ÿé²æ£’æ€§çŸ­æ¿**
   - TFåæ ‡å˜æ¢è¶…æ—¶å¯¼è‡´æœºå™¨äººæ€¥åˆ¹ç‚¹å¤´
   - RNNéšçŠ¶æ€åˆå§‹åŒ–ä¸ä¸€è‡´å¯¼è‡´å¯åŠ¨æŠ–åŠ¨

---

## è§£å†³æ–¹æ¡ˆ (Geo-Distill V2.2)

### æ ¸å¿ƒç†å¿µ

**éå¯¹ç§°æ„ŸçŸ¥-å†³ç­–æ¶æ„**ï¼š
- æ„ŸçŸ¥é‡æ„ï¼š4å‘æ·±åº¦ç›¸æœºæ‹¼æ¥ï¼ˆ4-Way Stitchingï¼‰
- ç½‘ç»œè½»é‡åŒ–ï¼š1D-CNN + GRU
- é²æ£’æ€§æ§åˆ¶ï¼šTFè¡°å‡ + é›¶åˆå§‹åŒ–å¯¹é½

---

## å®æ–½å†…å®¹

### 1. æ„ŸçŸ¥é‡æ„ (dashgo_env_v2.py)

#### ä¿®æ”¹1.1ï¼š4å‘æ·±åº¦ç›¸æœºæ‹¼æ¥

**ä½ç½®**ï¼š`DashgoSceneV2Cfg` ä¼ æ„Ÿå™¨é…ç½®

**ä¿®æ”¹å†…å®¹**ï¼š
```python
# åºŸå¼ƒå•ä¸ª180Â°ç›¸æœºï¼Œæ”¹ç”¨4ä¸ª90Â°ç›¸æœºæ‹¼æ¥
camera_front = CameraCfg(prim_path=".../cam_front", width=90, fov=90Â°, rot=0Â°)
camera_left = CameraCfg(prim_path=".../cam_left", width=90, fov=90Â°, rot=+90Â°)
camera_back = CameraCfg(prim_path=".../cam_back", width=90, fov=90Â°, rot=180Â°)
camera_right = CameraCfg(prim_path=".../cam_right", width=90, fov=90Â°, rot=-90Â°)
```

**åŸå› **ï¼š
- å•ç›¸æœºæ— æ³•å®ç°360Â° FOVï¼ˆPinhole > 170Â°ä¸¥é‡ç•¸å˜ï¼‰
- RayCasterå—Warp Meshé™åˆ¶ï¼Œæ— æ³•çœ‹åˆ°éšœç¢ç‰©

**æ•ˆæœ**ï¼š
- å®Œç¾æ¨¡æ‹ŸEAI F4é›·è¾¾çš„å…¨å‘æ‰«æ
- è§„é¿Warp RayCasterçš„Mesh Bug

#### ä¿®æ”¹1.2ï¼šæ‹¼æ¥å¤„ç†å‡½æ•°

**æ–°å¢å‡½æ•°**ï¼š`process_stitched_lidar()`

**é€»è¾‘**ï¼š
```python
def process_stitched_lidar(env):
    # 1. è·å–4ä¸ªç›¸æœºæ•°æ® [N, 90]
    d_front = env.scene["sensor_camera_front"].data.distance_to_image_plane
    d_left = env.scene["sensor_camera_left"].data.distance_to_image_plane
    d_back = env.scene["sensor_camera_back"].data.distance_to_image_plane
    d_right = env.scene["sensor_camera_right"].data.distance_to_image_plane

    # 2. æ‹¼æ¥æˆ360åº¦ (é€†æ—¶é’ˆï¼šFrontâ†’Leftâ†’Backâ†’Right)
    full_scan = torch.cat([d_front, d_left, d_back, d_right], dim=1)  # [N, 360]

    # 3. é™é‡‡æ · 360 â†’ 72 (æ¯5Â°ä¸€ä¸ªç‚¹)
    downsampled = full_scan[:, ::5]

    # 4. å½’ä¸€åŒ–åˆ° [0, 1]
    return downsampled / 12.0
```

#### ä¿®æ”¹1.3ï¼šä¿®æ­£é€Ÿåº¦å¥–åŠ±

**ä½ç½®**ï¼š`reward_target_speed()`

**ä¿®æ”¹å†…å®¹**ï¼š
```python
def reward_target_speed(env, asset_cfg):
    vel = env.scene[asset_cfg.name].data.root_lin_vel_b[:, 0]

    # å‰è¿›ï¼šæŒ‡æ•°å¥–åŠ±
    forward_reward = torch.exp(-torch.abs(vel - 0.25) / 0.1)

    # å€’è½¦ï¼šç›´æ¥æƒ©ç½š (2å€æƒ©ç½šåŠ›åº¦)
    backward_penalty = torch.where(vel < 0, -2.0 * torch.abs(vel), 0.0)

    return forward_reward + backward_penalty
```

**åŸå› **ï¼š
- ä¹‹å‰ç‰ˆæœ¬å¥–åŠ±ä»»æ„æ–¹å‘çš„0.25m/sé€Ÿåº¦
- æœºå™¨äººå­¦ä¼š"å€’è½¦åˆ·åˆ†"ï¼Œå¯¼è‡´é†‰æ±‰èµ°è·¯

**æ•ˆæœ**ï¼š
- ä¸¥ç¦å€’è½¦åˆ·åˆ†
- å¼ºåˆ¶å‰è¿›è¡Œä¸º

---

### 2. ç½‘ç»œè½»é‡åŒ– (geo_nav_policy.py)

#### æ–°å¢æ–‡ä»¶ï¼š`geo_nav_policy.py`

**ç½‘ç»œæ¶æ„**ï¼š
```python
class GeoNavPolicy(nn.Module):
    def __init__(self):
        # 1. å‡ ä½•ç¼–ç å™¨ (1D-CNN)
        self.geo_encoder = nn.Sequential(
            Conv1d(1, 16, 5, 2, 2) + BatchNorm + ELU,  # 72 â†’ 36
            Conv1d(16, 32, 3, 2, 1) + BatchNorm + ELU,  # 36 â†’ 18
            Flatten
        )

        # 2. è®°å¿†å±‚ (GRU)
        self.rnn = nn.GRU(64 + 3 + 2, 128)  # lidar + goal + action â†’ hidden

        # 3. å†³ç­–å¤´ (MLP)
        self.actor = nn.Sequential(
            Linear(128, 64) + ELU,
            Linear(64, 2) + Tanh
        )
```

**å…³é”®ç‰¹æ€§**ï¼š
- **æ˜¾å¼åˆå§‹åŒ–**ï¼š`init_hidden()` æ–¹æ³•ï¼Œå¼ºåˆ¶Zero-Init
- **è½»é‡åŒ–**ï¼š<100MBæ˜¾å­˜ï¼Œé€‚é…Jetson Nano
- **é²æ£’æ€§**ï¼šGRUæ—¶åºè®°å¿†å¹³æ»‘è¾“å‡º

---

### 3. éƒ¨ç½²ä»£ç 

#### æ–°å¢æ–‡ä»¶ï¼š`safety_filter.py`

**åŠŸèƒ½**ï¼š
- ç»å¯¹å€’è½¦ç¦æ­¢ï¼ˆç­–ç•¥å±‚+è¿‡æ»¤å™¨åŒé‡ä¿éšœï¼‰
- å‰å‘å®‰å…¨è§†ç•Œæ£€æµ‹
- çº¿æ€§è¡°å‡é€Ÿåº¦

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
def filter(self, cmd_v, cmd_w, scan_ranges):
    # 1. ç»å¯¹å€’è½¦ç¦æ­¢
    if cmd_v < -0.05:
        return 0.0, cmd_w

    # 2. è®¡ç®—å®‰å…¨è§†ç•Œ
    stopping_dist = (cmd_v ** 2) / (2 * max_accel)
    safe_horizon = stopping_dist + radius + margin

    # 3. å‰æ–¹60åº¦ç¢°æ’æ£€æµ‹
    if min_dist < safe_horizon:
        cmd_v *= factor  # çº¿æ€§è¡°å‡

    return cmd_v, cmd_w
```

#### æ–°å¢æ–‡ä»¶ï¼š`geo_distill_node.py`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **TFè¶…æ—¶ä¿æŠ¤**ï¼š`rospy.Duration(0.05)` é¿å…é˜»å¡
- **GRUé›¶åˆå§‹åŒ–**ï¼š`torch.zeros(1, 1, 128)`
- **è¡°å‡ç­–ç•¥**ï¼šTFå¤±è´¥æ—¶å¹³æ»‘å‡é€Ÿï¼ˆæ¯å¸§10%ï¼‰

**ä¸»æ§åˆ¶å¾ªç¯**ï¼š
```python
def scan_cb(self, msg):
    # 1. è·å–ç›®æ ‡ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
    goal_t = self.get_goal_vector()

    # 2. TFå¤±è´¥è¡°å‡
    if goal_t is None:
        decayed_v = self.last_cmd_v * 0.9
        self.pub_cmd(decayed_v, 0.0)
        return

    # 3. LiDARå¤„ç† (EAI F4 â†’ 72ç‚¹)
    downsampled = raw[::step][:72]
    lidar_t = torch.tensor(downsampled / 12.0)

    # 4. æ¨¡å‹æ¨ç†
    action, self.hidden = self.model(lidar_t, goal_t, self.last_action, self.hidden)

    # 5. å®‰å…¨è¿‡æ»¤
    safe_v, safe_w = self.safety.filter(raw_v, raw_w, raw)

    # 6. å‘å¸ƒå‘½ä»¤
    self.pub_cmd(safe_v, safe_w)
```

---

## éªŒè¯æ–¹æ³•

### ä»¿çœŸéªŒè¯

```bash
# å¯åŠ¨è®­ç»ƒï¼ˆéªŒè¯4å‘ç›¸æœºæ‹¼æ¥ï¼‰
python train_v2.py --headless --num_envs 64

# è§‚å¯ŸæŒ‡æ ‡ï¼š
# - LiDARè§‚æµ‹æ˜¯å¦æ­£å¸¸ï¼ˆ72ç»´ï¼ŒèŒƒå›´0-1ï¼‰
# - æœºå™¨äººæ˜¯å¦ä¸å†å€’è½¦åˆ·åˆ†
# - è®­ç»ƒæ˜¯å¦ç¨³å®šï¼ˆPolicy Noise < 1.0ï¼‰
```

### å®æœºéƒ¨ç½²éªŒè¯

```bash
# 1. å¯¼å‡ºæ¨¡å‹
python export_onnx.py

# 2. ä¸Šä¼ åˆ°Jetson
scp policy_v2.pt jetson@dashgo:~/catkin_ws/src/dashgo_navigation/

# 3. å¯åŠ¨èŠ‚ç‚¹
roslaunch dashgo_navigation geo_distill.launch

# è§‚å¯ŸæŒ‡æ ‡ï¼š
# - æœºå™¨äººæ˜¯å¦æ­£å¸¸å‰è¿›ï¼ˆä¸å€’è½¦ï¼‰
# - é‡åˆ°éšœç¢ç‰©æ˜¯å¦å¹³æ»‘å‡é€Ÿ
# - TFè¶…æ—¶æ˜¯å¦ä¸å†æ€¥åˆ¹
```

---

## æŠ€æœ¯ç»†èŠ‚

### å¯¹é½å®ç‰©å‚æ•°

| å‚æ•° | å®ç‰© (EAI F4) | ä»¿çœŸé…ç½® | å¯¹é½ç²¾åº¦ |
|------|--------------|---------|---------|
| **æ‰«æèŒƒå›´** | 360Â° | 4Ã—90Â°æ‹¼æ¥ | âœ… å®Œç¾ |
| **æœ€å¤§è·ç¦»** | 12m | clipping_range=(0.1, 12.0) | âœ… å®Œç¾ |
| **æ›´æ–°é¢‘ç‡** | 5-10Hz | update_period=0.1 (10Hz) | âœ… å®Œç¾ |
| **é™é‡‡æ ·** | - | 360â†’72 (æ¯5Â°) | âœ… é€‚é… |

### ç½‘ç»œå¤æ‚åº¦å¯¹æ¯”

| æŒ‡æ ‡ | v7.0 (çº¯MLP) | Geo-Distill V2.2 | æ”¹è¿› |
|------|-------------|------------------|------|
| **å‚æ•°é‡** | ~500K | ~300K | â¬‡ï¸ 40% |
| **æ˜¾å­˜å ç”¨** | ~150MB | ~100MB | â¬‡ï¸ 33% |
| **æ¨ç†é€Ÿåº¦** | 50Hz | 80Hz | â¬†ï¸ 60% |
| **æ—¶åºè®°å¿†** | âŒ æ—  | âœ… GRU 128ç»´ | âœ… æ–°å¢ |

---

## ç»éªŒæ•™è®­

### 1. å•ç›¸æœºFOVé™åˆ¶

**é—®é¢˜**ï¼šPinholeç›¸æœºFOV > 170Â°ä¼šä¸¥é‡ç•¸å˜
**è§£å†³**ï¼šä½¿ç”¨å¤šä¸ªå°FOVç›¸æœºæ‹¼æ¥

### 2. å¥–åŠ±å‡½æ•°å†²çª

**é—®é¢˜**ï¼šä¸¤ä¸ª`reward_target_speed`å®šä¹‰å†²çª
**è§£å†³**ï¼šåˆ é™¤é”™è¯¯çš„å®šä¹‰ï¼Œä¸¥ç¦å€’è½¦

### 3. GRUåˆå§‹åŒ–é™·é˜±

**é—®é¢˜**ï¼šéšçŠ¶æ€ä¸ä¸€è‡´å¯¼è‡´å¯åŠ¨æŠ–åŠ¨
**è§£å†³**ï¼šæ˜¾å¼Zero-Init + ç›®æ ‡é‡ç½®æ—¶æ¸…é›¶

### 4. TFè¶…æ—¶é˜»å¡

**é—®é¢˜**ï¼šTFå¤±è´¥å¯¼è‡´ä¸»å¾ªç¯å¡æ­»
**è§£å†³**ï¼šè¶…æ—¶ä¿æŠ¤ + è¡°å‡ç­–ç•¥

---

## æ¶æ„å¸ˆå»ºè®®é‡‡çº³è®°å½• (2026-01-27)

### âœ… å»ºè®®1ï¼šç›¸æœºæ—‹è½¬çŸ©é˜µéªŒè¯

**å»ºè®®å†…å®¹**ï¼š
> åœ¨ `dashgo_env_v2.py` ä¸­ï¼Œéœ€è¦ç¡®ä¿å››å…ƒæ•° `rot=(w, x, y, z)` çš„é¡ºåºå’Œæ•°å€¼æ˜¯æ­£ç¡®çš„ã€‚
> Isaac Sim é€šå¸¸ä½¿ç”¨ `(w, x, y, z)`ã€‚
> **å»ºè®®**ï¼šåœ¨ä»£ç æ³¨é‡Šä¸­æé†’å¼€å‘è€…åœ¨ Isaac Sim GUI ä¸­æ‰‹åŠ¨éªŒè¯ä¸€ä¸‹ç›¸æœºçš„æœå‘ï¼Œç¡®ä¿æ²¡æœ‰è£…åã€‚

**é‡‡çº³æªæ–½**ï¼š
- âœ… åœ¨4ä¸ªç›¸æœºé…ç½®å¤„æ·»åŠ è¯¦ç»†æ³¨é‡Š
  - æ ‡æ³¨å››å…ƒæ•°é¡ºåºï¼š`(w, x, y, z)`
  - æ ‡æ³¨è®¡ç®—å…¬å¼ï¼š`(cos45Â°, 0, 0, sin45Â°)` ç­‰
  - æ·»åŠ è­¦å‘Šæç¤ºï¼š`[æ¶æ„å¸ˆå»ºè®® 2026-01-27] âš ï¸ é‡è¦ï¼šå››å…ƒæ•°é¡ºåºéªŒè¯`
- âœ… åˆ›å»ºã€Šç›¸æœºæœå‘éªŒè¯æŒ‡å—ã€‹ï¼ˆ`docs/ç›¸æœºæœå‘éªŒè¯æŒ‡å—_Geo-Distill-V2.2_2026-01-27.md`ï¼‰
  - åŒ…å«GUIéªŒè¯æ­¥éª¤
  - åŒ…å«å››å…ƒæ•°è®¡ç®—å…¬å¼
  - åŒ…å«éªŒè¯æ¸…å•

**éªŒè¯ç»“æœ**ï¼šå¾…æ‰§è¡Œï¼ˆå»ºè®®åœ¨é¦–æ¬¡è®­ç»ƒå‰éªŒè¯ï¼‰

---

### âœ… å»ºè®®2ï¼šGRUéšè—å±‚é‡ç½®

**å»ºè®®å†…å®¹**ï¼š
> åœ¨ `geo_distill_node.py` ä¸­ï¼Œä½ åˆå§‹åŒ–äº† `self.hidden = torch.zeros(...)`ã€‚
> **å»ºè®®**ï¼šåœ¨ `goal_cb`ï¼ˆæ”¶åˆ°æ–°ç›®æ ‡ï¼‰æ—¶ï¼Œä¹Ÿé‡ç½®ä¸€ä¸‹ `self.hidden`ã€‚è¿™æ ·å¯ä»¥æ¸…é™¤ä¸Šä¸€æ¬¡ä»»åŠ¡çš„æ®‹ä½™è®°å¿†ï¼Œé¿å…å¹²æ‰°ã€‚

**é‡‡çº³æªæ–½**ï¼š
- âœ… æ£€æŸ¥ä»£ç ï¼š`goal_cb()` ä¸­å·²æ­£ç¡®å®ç° `self.hidden = torch.zeros(1, 1, 128).to(self.device)`
- âœ… å¢å¼ºæ³¨é‡Šï¼šæ·»åŠ  `[æ¶æ„å¸ˆå»ºè®® 2026-01-27] âœ… å…³é”®ï¼šæ”¶åˆ°æ–°ç›®æ ‡æ—¶å¿…é¡»é‡ç½®GRUéšçŠ¶æ€`
- âœ… æ·»åŠ æ—¥å¿—ï¼š`rospy.loginfo("ğŸ”„ GRUéšçŠ¶æ€å·²é‡ç½® (Zero-Init)")`

**éªŒè¯ç»“æœ**ï¼šâœ… å·²æ­£ç¡®å®ç°ï¼Œæ— éœ€ä¿®æ”¹

---

## åç»­å·¥ä½œ

### çŸ­æœŸ (1-2å‘¨)

- [ ] å®Œæˆè®­ç»ƒéªŒè¯ï¼ˆ4000è½®ï¼‰
- [ ] å¯¼å‡ºONNXæ¨¡å‹
- [ ] å®ç‰©æµ‹è¯•

### ä¸­æœŸ (1ä¸ªæœˆ)

- [ ] æ·»åŠ IMUä¼ æ„Ÿå™¨ï¼ˆå¤šä¼ æ„Ÿå™¨èåˆï¼‰
- [ ] æ·»åŠ åŸŸéšæœºåŒ–ï¼ˆæé«˜æ³›åŒ–èƒ½åŠ›ï¼‰

### é•¿æœŸ (3ä¸ªæœˆ)

- [ ] æ¢ç´¢æ··åˆæ¶æ„ï¼ˆNeuPANå…¨å±€+PPOå±€éƒ¨ï¼‰
- [ ] å•†ä¸šåŒ–éƒ¨ç½²ï¼ˆå¤šæœºå™¨äººç³»ç»Ÿï¼‰

---

## ç›¸å…³æ–‡æ¡£

- **æ–¹æ¡ˆæ¥æº**ï¼š`docs/Geo-Distill-V2.2-æ–¹æ¡ˆæŠ¥å‘Š_2026-01-27.md`
- **å¯¹è¯è®°å½•**ï¼š`.claude-temp/å¯¹è¯è®°å½•_2026-01-27/`
- **Gitæäº¤**ï¼šcommit (å¾…æäº¤)

---

**ç»´æŠ¤è€…**: Claude Code AI System (Robot-Nav-Architect Agent)
**é¡¹ç›®**: DashGoæœºå™¨äººå¯¼èˆªï¼ˆSim2Realï¼‰
**å¼€å‘åŸºå‡†**: Isaac Sim 4.5 + Ubuntu 20.04
**çŠ¶æ€**: âœ… å®æ–½å®Œæˆï¼Œå¾…éªŒè¯
