# Layer 7: 系统整体健康评估协议

> **按需加载**: 本文件是dialogue-optimizer skill的扩展协议，仅在系统健康评估时加载
> **依赖**: 需要先加载SKILL.md (Layer 1-4)
> **版本**: V5.0 Full-Ecosystem

---

## 触发条件

**自动触发**（满足任一）：
1. 用户说"系统健康评估"、"整体评估"、"全系统检查"
2. 每月定期评估（建议每月1次）
3. 系统重大更新后（Agent/Skill/规则大版本更新）
4. 用户明确要求"评估整个系统"

---

## Token消耗与性价比评估（核心）

### 为什么需要Token评估？

```yaml
问题场景:
  - Code-Reviewer Agent: 功能强大95分 ✅
  - 但是：每次评估消耗15K tokens ❌
  - 性价比低（功能/成本比不佳）

解决方案:
  添加token消耗评估
  → 量化每个Agent/Skill的成本
  → 计算性价比（功能/成本）
  → 优化高消耗低价值组件
```

### Token评估维度

#### 1. 单次调用消耗
```yaml
评估项:
  - 输入tokens (用户输入 + 上下文)
  - 输出tokens (AI输出)
  - 总消耗 = 输入 + 输出

示例:
  Agent: Code-Reviewer
  输入: 8K tokens (代码文件)
  输出: 7K tokens (评估报告)
  总消耗: 15K tokens
```

#### 2. 功能价值评分
```yaml
评估项:
  - 输出质量: 是否满足需求？（0-100分）
  - 可执行性: 建议是否具体？（0-100分）
  - 准确性: 是否有错误建议？（0-100分）

示例:
  Agent: Code-Reviewer
  输出质量: 95分
  可执行性: 90分
  准确性: 95分
  功能价值: (95+90+95)/3 = 93.3分
```

#### 3. 性价比计算
```yaml
公式:
  性价比 = 功能价值 / Token消耗 × 100

示例:
  Agent: Code-Reviewer
  功能价值: 93.3分
  Token消耗: 15K
  性价比: 93.3 / 15000 × 100 = 0.62

对比:
  Agent: Product
  功能价值: 85分
  Token消耗: 5K
  性价比: 85 / 5000 × 100 = 1.7 ✅ 更高

结论:
  Product性价比更高（1.7 vs 0.62）
```

#### 4. 优化建议
```yaml
基于性价比的优化建议:

低性价比 (< 0.5):
  - 精简输出（删除冗余内容）
  - 按需加载（不读取不需要的文件）
  - 缓存机制（重复内容引用）

中性价比 (0.5-1.0):
  - 适度优化
  - 提升输出质量

高性价比 (> 1.0):
  - 保持现状
  - 可作为最佳实践
```

### Token评估报告模板

```markdown
### Token消耗评估

| Agent/Skill | 输入Token | 输出Token | 总消耗 | 功能价值 | 性价比 | 评级 |
|-------------|-----------|-----------|--------|----------|--------|------|
| Code-Reviewer | 8K | 7K | 15K | 93.3 | 0.62 | 🟡 中 |
| Product | 3K | 2K | 5K | 85.0 | 1.70 | 🟢 高 |
| Architect | 5K | 4K | 9K | 82.0 | 0.91 | 🟢 高 |
| dialogue-optimizer | 1K | 1K | 2K | 94.0 | 4.70 | 🟢 高 |

**优化建议**:
- 🟡 Code-Reviewer: 性价比偏低，考虑精简输出
- 🟢 Product/Architect: 性价比高，保持现状
- ✅ dialogue-optimizer: 性价比最高，作为标杆
```

---

## 自测试用例

### 测试目的
验证dialogue-optimizer skill的评估准确性

### 测试用例1: Layer 5 Agent评估

```yaml
测试输入: "评估Code-Reviewer Agent V2.0"

预期输出:
  性能评分: 75/100
  主要问题: 6大错误
    1. 正则优化建议错误（性能倒退）
    2. 防DDoS逻辑颠倒
    3. AES加密过度设计
    4. Worker Pool过度设计
    5. 优先级误判
    6. Sleep阻塞问题
  Token消耗: ~15K
  性价比: 0.62（中）

测试步骤:
  1. Read layer5-agent-assessment.md
  2. 执行Layer 5协议
  3. 对比实际输出 vs 预期输出
  4. 评分差异 < 5分 → 通过
  5. 问题识别准确率 > 80% → 通过

测试结果: [待填写]
  - 性能评分: [实际]/100
  - 问题识别: [X]/6个
  - Token消耗: [实际]K
  - 通过状态: ✅ / ❌
```

### 测试用例2: Layer 6 Skill评估

```yaml
测试输入: "评估brainstorming skill"

预期输出:
  综合评分: 81/100
  主要问题:
    1. 缺少优先级排序
    2. description不清晰
    3. 缺少使用示例
  优化建议:
    1. 添加优先级评估机制
    2. 优化description
    3. 添加使用示例和输出模板
  Token消耗: ~3K
  性价比: 2.70（高）

测试步骤:
  1. Read layer6-skill-assessment.md
  2. 执行Layer 6协议
  3. 对比实际输出 vs 预期输出
  4. 评分差异 < 5分 → 通过
  5. 问题识别准确率 > 80% → 通过

测试结果: [待填写]
  - 综合评分: [实际]/100
  - 问题识别: [X]/3个
  - Token消耗: [实际]K
  - 通过状态: ✅ / ❌
```

### 测试用例3: 自我评估

```yaml
测试输入: "评估dialogue-optimizer skill"

预期输出:
  综合评分: 94/100
  主要优势:
    1. 架构设计优秀
    2. 功能完整性高
    3. 文档质量高
    4. 自我评估能力
  主要问题:
    1. 文档过载风险（轻微）
    2. 缺少自测试（待添加）
  Token消耗: ~5K
  性价比: 18.8（极高）

测试步骤:
  1. Read layer6-skill-assessment.md
  2. 执行Layer 6协议
  3. 验证自我评估准确性
  4. 评分差异 < 3分 → 通过

测试结果: [待填写]
  - 综合评分: [实际]/100
  - Token消耗: [实际]K
  - 通过状态: ✅ / ❌
```

### 测试用例4: Token消耗准确性

```yaml
测试输入: 评估消耗统计

预期行为:
  1. 准确计算输入token数
  2. 准确计算输出token数
  3. 正确计算性价比
  4. 给出合理评级

验证方法:
  - 对比AI估算 vs 实际计数
  - 误差 < 10% → 通过

测试结果: [待填写]
  - 输入token误差: [X]%
  - 输出token误差: [X]%
  - 通过状态: ✅ / ❌
```

---

## 系统健康评估维度

### 1. Agent健康度

```yaml
评估项:
  - Agent数量统计（共7个）
  - 触发器完整性（DR-015检查）
  - 平均评分（目标>85分）
  - 平均Token消耗（目标<10K）
  - 平均性价比（目标>1.0）

示例输出:
  Agent总数: 7个
  触发器完整: 100% (7/7) ✅
  平均评分: 88.4/100 ✅
  平均Token: 9.2K ⚠️
  平均性价比: 1.15 ✅

  问题识别:
    - Backend Agent: 82分，略低于目标
    - DevOps Agent: Token消耗12K，偏高

  优化建议:
    1. 优化Backend Agent（添加场景理解）
    2. 精简DevOps Agent输出
```

### 2. Skill健康度

```yaml
评估项:
  - Skill数量统计（共5个）
  - 调用成功率（目标>95%）
  - 平均评分（目标>80分）
  - 平均Token消耗（目标<5K）
  - 平均性价比（目标>2.0）

示例输出:
  Skill总数: 5个
  调用成功率: 98% ✅
  平均评分: 85.6/100 ✅
  平均Token: 4.1K ✅
  平均性价比: 4.2 ✅

  问题识别:
    - kaizen: 75分，文档不足

  优化建议:
    1. 优化kaizen文档（添加示例）
```

### 3. 触发器健康度

```yaml
评估项:
  - Trigger关键词覆盖度
  - DR-015违规检测
  - Trigger冲突检测

示例输出:
  Trigger覆盖度: 95% ✅
  DR-015违规: 0个 ✅
  Trigger冲突: 0个 ✅

  问题识别:
    - "代码重构"未包含在Code-Reviewer触发词中

  优化建议:
    1. 补充"代码重构"到Code-Reviewer触发词
```

### 4. 规则健康度

```yaml
评估项:
  - Active规则数量（最佳15-20个）
  - Deprecated规则数量（>5个需归档）
  - 规则冲突检测
  - 规则覆盖率评估

示例输出:
  Active规则: 18个 ✅
  Deprecated规则: 0个 ✅
  规则冲突: 0个 ✅
  规则覆盖: 高 ✅

  状态: 健康
```

### 5. 协作健康度

```yaml
评估项:
  - Agent + Agent协作（流水线）
  - Skill + Agent协作（评估更新）
  - Skill + Skill协作（链式调用）

示例输出:
  Agent协作: 90/100 ✅
  Skill-Agent协作: 88/100 ✅
  Skill-Skill协作: 75/100 ⚠️

  问题识别:
    - brainstorming → kaizen → tapestry缺少标准接口

  优化建议:
    1. 定义Skill协作中间数据格式
```

---

## 系统健康报告模板

```markdown
---
## 🏥 系统整体健康报告

### 评估时间
2026-01-23 16:30:00

### 总体评分
**系统健康度**: 88/100 ✅

### Token消耗总览

| 类别 | 数量 | 平均Token | 平均性价比 | 评级 |
|------|------|-----------|-----------|------|
| Agents | 7 | 9.2K | 1.15 | 🟢 好 |
| Skills | 5 | 4.1K | 4.2 | 🟢 优秀 |
| **总计** | **12** | **7.2K** | **2.3** | **🟢 优秀** |

**Token优化建议**:
- 🟡 优化Backend/DevOps输出（消耗>10K）
- ✅ dialogue-optimizer性价比最高（18.8），作为标杆

---

### 分项评分

#### 1. Agent健康度: 88/100 ✅

| Agent | 评分 | Token | 性价比 | 触发器 | 状态 |
|-------|------|-------|--------|--------|------|
| Product | 85 | 5K | 1.70 | ✅ | 🟢 |
| Architect | 82 | 9K | 0.91 | ✅ | 🟡 |
| Backend | 82 | 11K | 0.75 | ✅ | 🟡 |
| Frontend | 88 | 8K | 1.10 | ✅ | 🟢 |
| Code-Reviewer | 95 | 15K | 0.63 | ✅ | 🟡 |
| Docs | 92 | 6K | 1.53 | ✅ | 🟢 |
| DevOps | 87 | 12K | 0.73 | ✅ | 🟡 |

**平均**: 87.3分 | 9.4K | 1.05

**问题**:
- 🟡 Architect/Backend: 评分略低（<85分）
- 🟡 Code-Reviewer/DevOps: Token消耗偏高（>10K）

**优化建议**:
1. **优化Architect/Backend**: 添加Phase 0场景理解（目标: 85→90分）
2. **精简Code-Reviewer输出**: 性能倒退案例引用（15K→12K）

---

#### 2. Skill健康度: 86/100 ✅

| Skill | 评分 | Token | 性价比 | 状态 |
|-------|------|-------|--------|------|
| dialogue-optimizer | 94 | 5K | 18.8 | 🟢 |
| brainstorming | 81 | 3K | 2.70 | 🟢 |
| kaizen | 75 | 4K | 1.88 | 🟡 |
| file-organizer | 88 | 4K | 2.20 | 🟢 |
| tapestry | 90 | 5K | 1.80 | 🟢 |

**平均**: 85.6分 | 4.2K | 5.48

**问题**:
- 🟡 kaizen: 75分，文档不足

**优化建议**:
1. **优化kaizen文档**（75→85分）
   - 添加使用示例
   - 优化description

---

#### 3. 触发器健康度: 95/100 ✅

| Trigger | 覆盖度 | 违规 | 冲突 | 状态 |
|---------|--------|------|------|------|
| Trigger 1 (Agents) | 95% | 0 | 0 | 🟢 |

**问题**:
- ⚠️ 缺少触发词: "代码重构"、"性能调优"

**优化建议**:
1. 补充Code-Reviewer触发词
2. 补充Architect触发词

---

#### 4. 规则健康度: 90/100 ✅

| 指标 | 当前 | 目标 | 状态 |
|------|------|------|------|
| Active规则 | 18 | 15-20 | 🟢 |
| Deprecated | 0 | <5 | 🟢 |
| 冲突 | 0 | 0 | 🟢 |

**状态**: 健康

---

#### 5. 协作健康度: 84/100 ✅

| 协作类型 | 评分 | 状态 |
|----------|------|------|
| Agent + Agent | 90 | 🟢 |
| Skill + Agent | 88 | 🟢 |
| Skill + Skill | 75 | 🟡 |

**问题**:
- 🟡 Skill-Skill协作缺少标准接口

**优化建议**:
1. 定义Skill协作中间数据格式

---

### 优化优先级

#### 🔴 高优先级（本周执行）
1. **优化Code-Reviewer Token消耗**
   - 当前: 15K
   - 目标: 10K
   - 方法: 精简代码示例，引用替代重复
   - 预期收益: 性价比0.63→0.95

2. **优化kaizen文档**
   - 当前: 75分
   - 目标: 85分
   - 方法: 添加使用示例、优化description

#### 🟡 中优先级（本月执行）
3. **优化Architect/Backend**
   - 当前: 82分
   - 目标: 90分
   - 方法: 添加Phase 0场景理解

4. **补充Trigger关键词**
   - "代码重构" → Code-Reviewer
   - "性能调优" → Architect

#### 🟢 低优先级（有时间执行）
5. **定义Skill协作接口**
   - brainstorming → kaizen → tapestry
   - 标准化中间数据格式

---

### Token消耗趋势

```
上次评估（2025-12-23）: 平均8.5K
本次评估（2026-01-23）: 平均7.2K ✅
改进: -15% (节约1.3K tokens/次)

年度趋势:
  12月: 8.5K
  1月: 7.2K ✅ 改进
```

---

### 结论

**系统健康度**: 88/100 ✅

**关键指标**:
- Agent平均: 87.3分, 9.4K, 性价比1.05
- Skill平均: 85.6分, 4.2K, 性价比5.48
- 整体平均: 7.2K, 性价比2.3

**优势**:
- ✅ dialogue-optimizer性价比最高（18.8）
- ✅ 触发器配置完善
- ✅ 规则系统健康
- ✅ Token消耗持续下降（-15%）

**待优化**:
- 🟡 3个Agent需要优化（Architect/Backend/Code-Reviewer）
- 🟡 1个Skill需要优化（kaizen）
- 🟡 Skill-Skill协作需要标准化接口

**建议优先处理**: 高优先级1-2项，可将系统健康度提升至90+

---
```

---

## Prohibited Actions (系统健康评估相关)

🚫 **NEVER**:
- 未经用户确认直接修改多个Agent/Skill文件
- 仅基于token消耗判断价值（忽略功能价值）
- 盲目追求低token而牺牲输出质量

✅ **ALWAYS**:
- 综合评估: 功能价值 / Token消耗
- 务实主义: 性价比 > 极致优化
- 持续改进: 定期评估，渐进优化
- 数据驱动: 基于实际token计数

---

## 触发器更新建议

根据本次评估，建议更新以下Trigger关键词：

```yaml
Code-Reviewer Agent新增触发词:
  - "代码重构"
  - "性能调优"
  - "代码审查"

Architect Agent新增触发词:
  - "性能调优"
  - "架构优化"
  - "系统设计"
```

---

**版本**: V5.0 Full-Ecosystem
**最后更新**: 2026-01-23
**下次评估**: 2026-02-23（建议每月1次）
