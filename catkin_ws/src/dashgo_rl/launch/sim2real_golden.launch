<?xml version="1.0"?>
<launch>
    <!--
    ========================================================================
    DashGo RLå¯¼èˆª - Gazeboä»¿çœŸLaunchæ–‡ä»¶

    ç‰ˆæœ¬: v1.0
    æ›´æ–°: 2026-01-28
    ä½œè€…: Based on Architect's recommendation

    è¯´æ˜:
    - åŒ…å«ç®€åŒ–çš„Gazeboä»¿çœŸç¯å¢ƒï¼ˆä¸ä¾èµ–dashgo_gazeboåŒ…ï¼‰
    - åŒ…å«æœºå™¨äººçŠ¶æ€å‘å¸ƒ
    - åŒ…å«SLAMå»ºå›¾ï¼ˆGmappingï¼‰
    - åŒ…å«Rvizå¯è§†åŒ–
    - åŒ…å«RLå¯¼èˆªèŠ‚ç‚¹

    Fallbackç­–ç•¥:
    - å¦‚æœæ²¡æœ‰dashgoå®˜æ–¹åŒ…ï¼Œä½¿ç”¨ç®€å•çš„empty_world
    - å¯ä»¥é€šè¿‡Rvizçš„"2D Nav Goal"å‘é€ç›®æ ‡ç‚¹è¿›è¡Œæµ‹è¯•

    ä½¿ç”¨æ–¹æ³•:
    roslaunch dashgo_rl sim2real_golden.launch
    ========================================================================
    -->

    <arg name="model_path" default="$(find dashgo_rl)/models/policy_torchscript.pt"
         doc="TorchScriptæ¨¡å‹è·¯å¾„"/>

    <arg name="max_lin_vel" default="0.3"
         doc="æœ€å¤§çº¿é€Ÿåº¦ (m/s)"/>

    <arg name="max_ang_vel" default="1.0"
         doc="æœ€å¤§è§’é€Ÿåº¦ (rad/s)"/>

    <arg name="max_lin_acc" default="1.0"
         doc="æœ€å¤§çº¿åŠ é€Ÿåº¦ (m/sÂ²)"/>

    <arg name="max_ang_acc" default="0.6"
         doc="æœ€å¤§è§’åŠ é€Ÿåº¦ (rad/sÂ²)"/>

    <arg name="control_rate" default="20"
         doc="æ§åˆ¶é¢‘ç‡ (Hz)"/>

    <arg name="enable_gazebo" default="true"
         doc="æ˜¯å¦å¯åŠ¨Gazeboä»¿çœŸï¼ˆå¦‚æœå·²æœ‰Gazeboåœ¨è¿è¡Œï¼Œè®¾ä¸ºfalseï¼‰"/>

    <arg name="enable_gmapping" default="true"
         doc="æ˜¯å¦å¯åŠ¨SLAMå»ºå›¾"/>

    <arg name="enable_rviz" default="true"
         doc="æ˜¯å¦å¯åŠ¨Rvizå¯è§†åŒ–"/>

    <!-- ========================================================================
         Gazeboä»¿çœŸï¼ˆç®€åŒ–ç‰ˆFallbackï¼‰
    ======================================================================== -->
    <group if="$(arg enable_gazebo)">
        <!-- æ–¹æ¡ˆAï¼šå¦‚æœå­˜åœ¨dashgo_gazeboåŒ…ï¼Œä½¿ç”¨å®˜æ–¹launch -->
        <!--
        <include file="$(find dashgo_gazebo)/launch/dashgo_d1_gazebo.launch" if="$(exists dashgo_gazebo)">
            <arg name="gui" value="true"/>
        </include>
        -->

        <!-- æ–¹æ¡ˆBï¼šFallback - ä½¿ç”¨ç®€å•ç©ºä¸–ç•Œï¼ˆå½“å‰ä½¿ç”¨ï¼‰ -->
        <include file="$(find gazebo_ros)/launch/empty_world.launch">
            <arg name="world_name" value="worlds/empty.world"/>
            <arg name="paused" value="false"/>
            <arg name="use_sim_time" value="true"/>
            <arg name="gui" value="true"/>
            <arg name="headless" value="false"/>
            <arg name="debug" value="false"/>
        </include>

        <!-- æ³¨æ„ï¼šæ­¤ç®€åŒ–ç‰ˆæœ¬éœ€è¦å•ç‹¬spawnæœºå™¨äººæ¨¡å‹ -->
        <!-- å¦‚æœéœ€è¦å®Œæ•´æœºå™¨äººæ¨¡å‹ï¼Œè¯·å®‰è£…dashgo_descriptionåŒ… -->

        <!-- ========================================================================
             åœ¨Gazeboä¸­spawnæœºå™¨äººæ¨¡å‹
        ======================================================================== -->
        <node name="spawn_dashgo" pkg="gazebo_ros" type="spawn_model"
              args="-urdf -param robot_description -model dashgo -x 0 -y 0 -z 0.05"
              output="screen"/>
    </group>

    <!-- ========================================================================
         æœºå™¨äººæè¿°ï¼ˆURDFï¼‰ - å¿…é¡»åœ¨robot_state_publisherä¹‹å‰åŠ è½½
    ======================================================================== -->
    <param name="robot_description"
           command="$(find xacro)/xacro $(find dashgo_rl)/urdf/dashgo_d1_sim.urdf.xacro" />

    <!-- ========================================================================
         æœºå™¨äººçŠ¶æ€å‘å¸ƒ
    ======================================================================== -->
    <node name="robot_state_publisher" pkg="robot_state_publisher"
          type="robot_state_publisher" />

    <node name="joint_state_publisher" pkg="joint_state_publisher"
          type="joint_state_publisher">
      <param name="use_gui" value="false"/>
      <rosparam param="source_list">[/joint_states]</rosparam>
    </node>

    <!-- ========================================================================
         SLAMå»ºå›¾ï¼ˆGmappingï¼‰
    ======================================================================== -->
    <group if="$(arg enable_gmapping)">
        <node pkg="gmapping" type="slam_gmapping" name="slam_gmapping"
              output="screen">

            <!-- åæ ‡ç³»é…ç½® -->
            <param name="base_frame" value="base_link"/>
            <param name="odom_frame" value="odom"/>
            <param name="map_frame" value="map"/>

            <!-- é›·è¾¾å‚æ•° -->
            <param name="map_update_interval" value="1.0"/>
            <param name="maxUrange" value="10.0"/>  <!-- æœ€å¤§æœ‰æ•ˆè·ç¦» -->
            <param name="maxRange" value="12.0"/>   <!-- é›·è¾¾æœ€å¤§è·ç¦» -->
            <param name="sigma" value="0.05"/>
            <param name="kernelSize" value="1"/>
            <param name="lstep" value="0.05"/>
            <param name="astep" value="0.05"/>
            <param name="iterations" value="5"/>
            <param name="lsigma" value="0.075"/>
            <param name="ogain" value="3.0"/>
            <param name="lskip" value="0"/>
            <param name="srr" value="0.1"/>
            <param name="srt" value="0.2"/>
            <param name="str" value="0.1"/>
            <param name="stt" value="0.2"/>
            <param name="linearUpdate" value="1.0"/>
            <param name="angularUpdate" value="0.5"/>
            <param name="temporalUpdate" value="3.0"/>
            <param name="resampleThreshold" value="0.5"/>
            <param name="particles" value="30"/>

            <!-- åœ°å›¾å°ºå¯¸ -->
            <param name="xmin" value="-50.0"/>
            <param name="ymin" value="-50.0"/>
            <param name="xmax" value="50.0"/>
            <param name="ymax" value="50.0"/>
            <param name="delta" value="0.05"/>

            <!-- å…¶ä»–å‚æ•° -->
            <param name="llsamplerange" value="0.01"/>
            <param name="llsamplestep" value="0.01"/>
            <param name="lasamplerange" value="0.005"/>
            <param name="lasamplestep" value="0.005"/>
        </node>
    </group>

    <!-- ========================================================================
         Rvizå¯è§†åŒ–
    ======================================================================== -->
    <group if="$(arg enable_rviz)">
        <!-- å°è¯•åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤é…ç½® -->
        <node pkg="rviz" type="rviz" name="rviz"
              args="-d $(find dashgo_rl)/rviz/nav.rviz"
              unless="$(eval not('$(exists $(find dashgo_rl)/rviz/nav.rviz)'))"/>

        <node pkg="rviz" type="rviz" name="rviz"
              if="$(eval not('$(exists $(find dashgo_rl)/rviz/nav.rviz)'))"/>
    </group>

    <!-- ========================================================================
         RLå¯¼èˆªèŠ‚ç‚¹ï¼ˆæ ¸å¿ƒï¼‰
    ======================================================================== -->
    <node pkg="dashgo_rl" type="geo_nav_node.py" name="geo_nav_node"
          output="screen" required="true">

        <!-- æ¨¡å‹è·¯å¾„ -->
        <param name="model_path" value="$(arg model_path)" />

        <!-- é€Ÿåº¦é™åˆ¶ï¼ˆä¸dashgo_config.pyä¸€è‡´ï¼‰ -->
        <param name="max_lin_vel" value="$(arg max_lin_vel)" />
        <param name="max_ang_vel" value="$(arg max_ang_vel)" />

        <!-- ğŸ”¥ [æ–°å¢] åŠ é€Ÿåº¦é™åˆ¶å‚æ•°ï¼ˆå®‰å…¨å…³é”®ï¼‰ -->
        <param name="max_lin_acc" value="$(arg max_lin_acc)" />
        <param name="max_ang_acc" value="$(arg max_ang_acc)" />

        <!-- ğŸ”¥ [ä¿®æ­£] æ§åˆ¶é¢‘ç‡ï¼ˆåŠ¨æ€è®¡ç®—dtï¼‰ -->
        <param name="control_rate" value="$(arg control_rate)" />
    </node>

</launch>
